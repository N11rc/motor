<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <title>Moto Rota Hava Durumu - Risk Segmentli Çizim</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""
    />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        :root {
            --color-bg: #111;
            --color-text: #eee;
            --color-primary: #1e88e5;
            --color-danger: #f44336;
            --color-warning: #ff9800;
            --color-success: #4caf50;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            overflow: hidden; 
        }

        #controls {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 10px;
            background: var(--color-bg);
            color: var(--color-text);
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: flex-end; 
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }

        #controls label {
            display: inline-flex;
            flex-direction: column;
            font-size: 13px;
            flex-grow: 1; 
            min-width: 140px; 
        }

        #controls input,
        #controls button {
            padding: 8px 10px;
            font-size: 14px;
            border-radius: 4px;
            border: 1px solid #555;
            color: var(--color-text);
        }

        #controls input {
            background: #222;
        }

        #departureInput {
            min-width: 180px;
        }

        #routeBtn, #trackBtn {
            background: var(--color-primary);
            color: white;
            cursor: pointer;
            border: none;
            transition: background 0.2s;
            white-space: nowrap; 
        }
        
        #routeBtn:hover:not(:disabled), #trackBtn:hover:not(:disabled) {
            background: #0d47a1;
        }

        #controls button:disabled {
            opacity: 0.6;
            cursor: default;
        }

        #status-container {
            width: 100%;
            padding: 5px 0 0;
            display: flex;
            align-items: center;
        }
        
        #status {
            font-size: 13px;
            color: #ccc;
            flex-grow: 1;
        }

        #map {
            width: 100%;
            height: 100vh;
        }

        /* --- LEAFLET UI & LEGEND İYİLEŞTİRMELERİ --- */
        .leaflet-control-container .leaflet-control.legend {
            margin-bottom: 30px; 
        }
        
        .legend {
            background: rgba(0, 0, 0, 0.8);
            color: var(--color-text);
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 12px;
            line-height: 1.6;
        }

        .legend div {
            display: flex;
            align-items: center;
        }

        .legend span {
            display: inline-block;
            width: 10px;
            height: 10px;
            margin-right: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        /* Mobil Görünüm İyileştirmesi (768px altı) */
        @media (max-width: 768px) {
            #controls {
                flex-direction: column;
                align-items: stretch;
            }

            #controls label, #controls button {
                min-width: unset;
                width: 100%;
            }
            
            #controls button {
                margin-top: 5px; 
            }
            
            #status-container {
                padding-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="controls">
        <label>Başlangıç:
            <input id="startInput" type="text" placeholder="Örn: Pendik, İstanbul" />
        </label>
        <label>Bitiş:
            <input id="endInput" type="text" placeholder="Örn: Milas, Muğla" />
        </label>
        <label>Çıkış saati (Şimdi):
            <input id="departureInput" type="datetime-local" /> 
        </label>
        <button id="routeBtn"><i class="fas fa-motorcycle"></i> Rota Çiz</button>
        <button id="trackBtn"><i class="fas fa-location-arrow"></i> Konum Takibi</button>
        
        <div id="status-container">
            <span id="status">Harita hazır. Başlangıç ve bitiş giriniz.</span>
        </div>
    </div>
    <div id="map"></div>

    <script
        src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""
    ></script>

    <script>
        // --- Sabitler ---
        const DANGER_WIND = 40; // km/s
        const WARNING_WIND = 25; // km/s
        const DANGER_PRECIP = 2; // mm/saat
        const WARNING_PRECIP = 0.1; // mm/saat
        const SAMPLE_COUNT = 30; // Rota çizgisini bölmek için kullanılan örnek nokta sayısı

        // --- Haritayı başlat ---
        const map = L.map("map").setView([39.0, 35.0], 6); // Türkiye ortalama

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 18,
            attribution: '&copy; OpenStreetMap & OSRM & Open-Meteo',
        }).addTo(map);

        const routeLayerGroup = L.layerGroup().addTo(map);
        const weatherLayerGroup = L.layerGroup().addTo(map);
        let trackingMarker = null;
        let watchId = null; 

        const statusEl = document.getElementById("status");
        const routeBtn = document.getElementById("routeBtn");
        const trackBtn = document.getElementById("trackBtn");

        // Basit legend
        const legend = L.control({ position: "bottomright" });
        legend.onAdd = function () {
            const div = L.DomUtil.create("div", "legend");
            div.innerHTML = `
                <b>ROTA VE MARKER RİSK</b>
                <div><span style="background:var(--color-danger)"></span> Yüksek Risk (> ${DANGER_WIND} km/s VEYA > ${DANGER_PRECIP} mm)</div>
                <div><span style="background:var(--color-warning)"></span> Orta Risk (> ${WARNING_WIND} km/s VEYA > ${WARNING_PRECIP} mm)</div>
                <div><span style="background:var(--color-success)"></span> Düşük Risk (İyi)</div>
            `;
            return div;
        };
        legend.addTo(map);

        function setStatus(msg) {
            statusEl.textContent = msg || "";
        }

        function setLoading(loading) {
            routeBtn.disabled = loading;
            const icon = loading ? 'fa-spinner fa-spin' : 'fa-motorcycle';
            routeBtn.innerHTML = `<i class="fas ${icon}"></i> ${loading ? "Hesaplanıyor..." : "Rota Çiz"}`;
        }
        
        // --- Yardımcı Fonksiyonlar ---
        
        function getWeatherRisk(info) {
            const { precipitation, wind } = info;
            if (precipitation > DANGER_PRECIP || wind >= DANGER_WIND) {
                return 3; // Kırmızı (Yüksek)
            }
            if (precipitation > WARNING_PRECIP || wind >= WARNING_WIND) {
                return 2; // Turuncu (Orta)
            }
            return 1; // Yeşil (Düşük)
        }

        function getRiskColor(riskLevel) {
            switch (riskLevel) {
                case 3: return "#f44336"; // Kırmızı
                case 2: return "#ff9800"; // Turuncu
                default: return "#4caf50"; // Yeşil
            }
        }
        
        async function geocode(query) {
            const url = "https://nominatim.openstreetmap.org/search?format=json&limit=1&q=" + encodeURIComponent(query);
            const res = await fetch(url, { headers: { "Accept-Language": "tr" } });
            if (!res.ok) throw new Error("Konum sorgulama başarısız: " + res.status);
            const data = await res.json();
            if (!data || data.length === 0) throw new Error("Konum bulunamadı: " + query);
            const item = data[0];
            return { lat: parseFloat(item.lat), lon: parseFloat(item.lon), display_name: item.display_name };
        }

        async function getRoute(start, end) {
            const url = "https://router.project-osrm.org/route/v1/driving/" + [start.lon, start.lat].join(",") + ";" + [end.lon, end.lat].join(",") + "?overview=full&geometries=geojson";
            const res = await fetch(url);
            if (!res.ok) throw new Error("Rota isteği başarısız: " + res.status);
            const data = await res.json();
            if (!data.routes || data.routes.length === 0) throw new Error("Rota bulunamadı.");
            return data.routes[0];
        }

        // Rota koordinatlarını Leaflet formatına çevirir
        function getLatLngCoords(geometry) {
            return geometry.coordinates.map((c) => [c[1], c[0]]); // [lon, lat] -> [lat, lon]
        }

        async function getHourlyWeather(lat, lon) {
            const url = "https://api.open-meteo.com/v1/forecast?latitude=" + lat + "&longitude=" + lon + "&hourly=temperature_2m,precipitation,wind_speed_10m&forecast_days=7&timezone=auto";
            const res = await fetch(url);
            if (!res.ok) throw new Error("Hava isteği başarısız: " + res.status);
            const data = await res.json();
            if (!data.hourly || !data.hourly.time) throw new Error("Saatlik hava verisi bulunamadı.");
            return data.hourly;
        }

        function findNearestHourIndex(times, targetDate) {
            let bestIdx = 0;
            let bestDiff = Infinity;
            for (let i = 0; i < times.length; i++) {
                const t = new Date(times[i]);
                const diff = Math.abs(t - targetDate);
                if (diff < bestDiff) {
                    bestDiff = diff;
                    bestIdx = i;
                }
            }
            return bestIdx;
        }

        // --- ANA ROTA İŞLEYİCİ ---
        async function handleRoute() {
            const startText = document.getElementById("startInput").value.trim();
            const endText = document.getElementById("endInput").value.trim();
            const departureInput = document.getElementById("departureInput").value;

            if (!startText || !endText) {
                alert("Başlangıç ve bitiş noktalarını yazmalısınız.");
                return;
            }

            let departureTime = departureInput ? new Date(departureInput) : new Date();
            
            if (departureTime.toString() === "Invalid Date") {
                alert("Geçerli bir çıkış saati giriniz.");
                return;
            }

            routeLayerGroup.clearLayers();
            weatherLayerGroup.clearLayers();
            setStatus("Konumlar çözümleniyor...");
            setLoading(true);

            try {
                // 1) Geocode
                const [start, end] = await Promise.all([geocode(startText), geocode(endText)]);
                
                // Başlangıç/Bitiş Markerları
                const startIcon = L.icon({iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]});
                const endIcon = L.icon({iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]});
                
                L.marker([start.lat, start.lon], {icon: startIcon}).addTo(routeLayerGroup).bindPopup(`<b>Başlangıç:</b> ${start.display_name}`).openPopup();
                const endMarker = L.marker([end.lat, end.lon], {icon: endIcon}).addTo(routeLayerGroup).bindPopup(`<b>Bitiş:</b> ${end.display_name}`);

                setStatus("Rota hesaplanıyor...");

                // 2) Rota
                const route = await getRoute(start, end);
                const totalDurationSec = route.duration;

                // Rotayı Leaflet koordinatlarına çevir
                const allRouteCoords = getLatLngCoords(route.geometry);
                
                // Rotayı bölmek için eşit aralıklarla örnek nokta indeksleri al
                const totalPoints = allRouteCoords.length;
                const indices = [];
                for (let i = 0; i < SAMPLE_COUNT; i++) {
                    indices.push(Math.round(i / (SAMPLE_COUNT - 1) * (totalPoints - 1)));
                }

                setStatus("Hava durumu ve segmentler belirleniyor...");
                
                let lastRisk = 0; // Başlangıçta risk yok
                let segmentStartIdx = 0;
                let segmentCoordinates = [];
                let segmentResults = [];

                for (let i = 0; i < indices.length; i++) {
                    const currentRouteIdx = indices[i];
                    const currentCoords = allRouteCoords[currentRouteIdx];
                    const fraction = currentRouteIdx / (totalPoints - 1); // Rota üzerinde 0.0-1.0 oranı
                    
                    // Bu noktaya tahmini varış/geçiş zamanı
                    const estimatedArrivalTime = new Date(
                        departureTime.getTime() + fraction * totalDurationSec * 1000
                    );

                    // Hava durumu verilerini al
                    const hourly = await getHourlyWeather(currentCoords[0], currentCoords[1]);
                    const idx = findNearestHourIndex(hourly.time, estimatedArrivalTime);

                    const temp = hourly.temperature_2m[idx];
                    const precip = hourly.precipitation[idx];
                    const wind = hourly.wind_speed_10m[idx];
                    const risk = getWeatherRisk({ precipitation: precip, wind });
                    
                    // Marker (daire) oluştur ve detayları ekle
                    const markerColor = getRiskColor(risk);
                    const marker = L.circleMarker(currentCoords, {
                        radius: 7,
                        color: markerColor,
                        weight: 2,
                        fillColor: markerColor,
                        fillOpacity: 0.8,
                    }).bindPopup(`
                        <b>Tahmini Varış:</b> ${estimatedArrivalTime.toLocaleString("tr-TR")}<br/>
                        <b>Sıcaklık:</b> ${temp.toFixed(1)} °C<br/>
                        <b>Rüzgar:</b> ${wind.toFixed(1)} km/s<br/>
                        <b>Yağış:</b> ${precip.toFixed(2)} mm/saat
                    `);
                    weatherLayerGroup.addLayer(marker);
                    
                    // --- SEGMENTASYON MANTIĞI ---
                    if (risk !== lastRisk && lastRisk !== 0) {
                        // Risk değişti, önceki segmenti kaydet ve çiz
                        const segmentCoords = allRouteCoords.slice(segmentStartIdx, currentRouteIdx + 1);
                        segmentResults.push({ coords: segmentCoords, color: getRiskColor(lastRisk) });
                        
                        // Yeni segmentin başlangıcını ayarla
                        segmentStartIdx = currentRouteIdx;
                    }
                    
                    lastRisk = risk;

                    // Eğer son örnek nokta ise, kalan kısmı da segment olarak kaydet
                    if (i === indices.length - 1) {
                         const segmentCoords = allRouteCoords.slice(segmentStartIdx, allRouteCoords.length);
                         segmentResults.push({ coords: segmentCoords, color: getRiskColor(lastRisk) });
                    }
                }
                
                // 3) Segmentleri haritaya çiz
                segmentResults.forEach(segment => {
                    const polyline = L.polyline(segment.coords, { 
                        color: segment.color, 
                        weight: 6, 
                        opacity: 0.8 
                    });
                    routeLayerGroup.addLayer(polyline);
                });
                
                // Haritayı rotaya odakla
                map.fitBounds(L.polyline(allRouteCoords).getBounds(), { padding: [80, 80] });

                setStatus(
                    "Rota segmentlere ayrıldı. Toplam süre: " +
                    (totalDurationSec / 3600).toFixed(1) +
                    " saat. Risk durumuna göre rota rengi değişir."
                );
            } catch (err) {
                console.error(err);
                alert("Rota çizilirken bir hata oluştu: " + err.message);
                setStatus("Hata oluştu.");
            } finally {
                setLoading(false);
            }
        }
        
        // --- KONUM TAKİBİ İŞLEYİCİ (v3'ten alınmıştır) ---
        function toggleGeolocation() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                if (trackingMarker) {
                    map.removeLayer(trackingMarker);
                    trackingMarker = null;
                }
                trackBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Konum Takibi';
                trackBtn.style.background = 'var(--color-primary)';
                setStatus("Konum takibi durduruldu.");
            } else {
                if (!navigator.geolocation) {
                    alert('Tarayıcınız konum servislerini desteklemiyor.');
                    return;
                }
                
                trackBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Başlatılıyor...';
                trackBtn.style.background = '#888';
                
                const bikeIcon = L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34]
                });

                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        const latLng = [position.coords.latitude, position.coords.longitude];
                        
                        if (!trackingMarker) {
                            trackingMarker = L.marker(latLng, {icon: bikeIcon}).addTo(map);
                            trackingMarker.bindPopup("<b>Şu Anki Konumunuz</b>").openPopup();
                            map.setView(latLng, 14);
                        } else {
                            trackingMarker.setLatLng(latLng);
                            map.panTo(latLng); 
                        }
                        
                        trackBtn.innerHTML = '<i class="fas fa-times-circle"></i> Takip Ediliyor';
                        trackBtn.style.background = 'var(--color-danger)';
                        setStatus(`Konum güncellendi. Doğruluk: ${position.coords.accuracy.toFixed(0)}m.`);
                    }, 
                    (error) => {
                        alert(`Konum hatası: ${error.message}`);
                        toggleGeolocation();
                    }, 
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            }
        }
        
        routeBtn.addEventListener("click", handleRoute);
        trackBtn.addEventListener("click", toggleGeolocation);
        
        // Giriş alanlarına Enter tuşu dinleyicisi ekle
        document.getElementById("startInput").addEventListener("keypress", function(e) {
            if (e.key === 'Enter') handleRoute();
        });
        document.getElementById("endInput").addEventListener("keypress", function(e) {
            if (e.key === 'Enter') handleRoute();
        });
    </script>
</body>
</html>
