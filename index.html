<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <title>Moto Rota Hava Durumu - V3 (Geliştirilmiş ve Hata Düzeltmeli)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""
    />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://unpkg.com/@mapbox/togeojson@0.16.0/togeojson.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>

    <style>
        /* CRITICAL: Mobil Uyum için HTML/BODY ayarları */
        html, body {
            height: 100%; /* Mutlak yükseklik */
            width: 100%;  /* Mutlak genişlik */
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            overflow: hidden; 
        }

        :root {
            --color-bg: #111;
            --color-text: #eee;
            --color-primary: #1e88e5;
            --color-danger: #f44336;
            --color-warning: #ff9800;
            --color-success: #4caf50;
            --color-info: #00bcd4;
        }

        /* 1. GELİŞTİRME: KARANLIK MOD (Varsayılan Tema) */
        /* Ekstil CSS sınıfları JavaScript ile 'body' elementine eklenecektir */
        body.dark-mode { 
            --color-bg: #111;
            --color-text: #eee;
            background-color: #111; 
        }
        body.light-mode {
             --color-bg: #fff;
             --color-text: #333;
             background-color: #fff;
        }
        
        * { box-sizing: border-box; }

        /* KONTROL ÇUBUĞU */
        #controls {
            position: absolute; top: 0; left: 0; right: 0; padding: 10px; background: var(--color-bg);
            color: var(--color-text); display: flex; flex-direction: column; gap: 10px; z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5); 
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            max-height: 250px; overflow: hidden; width: 100%; 
        }
        /* Karanlık/Aydınlık modda kontrol çubuğu rengi adaptasyonu */
        body.dark-mode #controls { background: #111; color: #eee; }
        body.light-mode #controls { background: #fff; color: #333; border-bottom: 1px solid #ddd; }
        body.light-mode #controls input { background: #eee; color: #333; border: 1px solid #ccc; }


        #controls.minimized { max-height: 100px; padding-bottom: 5px; } 
        
        #controls-inputs {
            display: flex; flex-wrap: wrap; gap: 10px; flex-grow: 1; align-items: flex-end;
            transition: opacity 0.3s; width: 100%; 
        }
        #controls.minimized #controls-inputs { 
            opacity: 0; 
            pointer-events: none; 
            height: 0; 
            margin-bottom: -10px; 
        }
        
        /* 6. GELİŞTİRME: ÇOKLU DURAK STİLİ */
        #durak-listesi label { display: flex; align-items: center; margin-bottom: 5px; gap: 5px; }
        .durak-item { display: flex; gap: 5px; align-items: center; width: 100%; }
        .durak-item input { flex-grow: 1; }
        .durak-item button { background: var(--color-danger); color: white; border: none; padding: 5px; border-radius: 4px; cursor: pointer; }
        .drag-handle { cursor: grab; color: #999; padding: 5px; }
        #addDurakBtn { background: #444; color: white; border: none; padding: 8px 10px; border-radius: 4px; cursor: pointer; }

        #controls label {
            display: flex; flex-direction: column; font-size: 13px; flex-grow: 1; min-width: 140px; position: relative;
        }
        @media (max-width: 768px) {
            #controls label, #controls-inputs { width: 100%; }
            #controls label { min-width: unset; }
        }
        
        .location-button {
            position: absolute; right: 1px; top: 50%; transform: translateY(calc( -50% + 8px)); cursor: pointer;
            color: var(--color-primary); background: none; border: none; padding: 7px; z-index: 2; font-size: 16px;
        }

        #controls input { 
            background: #222; 
            padding-right: 35px; 
            width: 100%; 
            border: 1px solid #333;
            color: var(--color-text);
            padding: 8px 10px;
            border-radius: 4px;
        }
        #controls-buttons { 
            display: flex; gap: 10px; width: 100%; 
        }

        #routeBtn, #trackBtn, #settingsBtn, #clearBtn {
            padding: 8px 10px; font-size: 14px; border-radius: 4px; border: none; color: white; cursor: pointer;
            transition: background 0.2s; white-space: nowrap; 
        }
        
        #routeBtn { background: var(--color-primary); flex-grow: 2; }
        #trackBtn { background: var(--color-primary); flex-grow: 2; }
        #settingsBtn { background: #444; flex-grow: 1; }
        #clearBtn { 
            background: #777; 
            flex-grow: 2; 
            display: none; 
        }
        #controls.minimized #clearBtn { display: inline-block; }

        /* HARİTA GÖRÜNÜMÜ - KRİTİK DÜZELTME */
        #map { 
            width: 100%; 
            height: 100%; /* Sayfanın tamamını kapla */
            position: relative; /* Safari/Opera/Mobil için zorunlu */
            z-index: 1; 
        }

        /* SAĞ ÜST KONTROL BUTONLARI */
        #mapToggleBtn, #poiControls, #speedometer {
            position: absolute;
            right: 10px;
            z-index: 999;
            background: rgba(17, 17, 17, 0.8);
            color: var(--color-text);
            padding: 10px;
            border-radius: 4px;
            border: none;
            box-shadow: 0 1px 5px rgba(0,0,0,0.65);
            transition: background 0.2s;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        /* 3. GELİŞTİRME: HIZ GÖSTERGESİ STİLİ */
        #speedometer {
            top: 10px;
            padding: 15px;
            width: 140px;
            text-align: center;
        }
        #speedometer.hidden { display: none !important; }

        #currentSpeed, #speedLimit { font-size: 24px; font-weight: bold; }
        #speedLimit { color: #ccc; font-size: 14px; margin-top: 5px; }
        #currentSpeed.red-text { color: var(--color-danger); }

        /* Mobil Cihazlar İçin Pozisyon Ayarı */
        @media (max-width: 768px) {
            /* Üst Kontrol Çubuğunun minimum yüksekliği yaklaşık 100px */
            #speedometer { top: 110px; right: 10px; } 
            #mapToggleBtn { top: 110px; left: 10px; right: unset; } 
            #poiControls { top: 160px; } 
            .leaflet-top.leaflet-right { top: 250px !important; } 
        }
        @media (min-width: 769px) {
             #speedometer { top: 10px; }
             #mapToggleBtn { top: 110px; }
             #poiControls { top: 160px; }
        }


        .poi-button {
            background: #333;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            text-align: left;
            border: 1px solid #444;
            transition: background 0.2s;
        }
        .poi-button:hover { background: #444; }
        .poi-button.active { 
            background: var(--color-info); 
            border-color: var(--color-info); 
        }

        #poiControls { display: none; padding: 10px 15px; } /* Başlangıçta gizli */

        /* Geri kalan CSS (Legend, Modal vs.) */
        #status-container { width: 100%; padding: 5px 0 0; display: flex; align-items: center; }
        #status { font-size: 13px; color: #ccc; flex-grow: 1; }
        .leaflet-control-zoom { border-radius: 4px !important; box-shadow: 0 1px 5px rgba(0,0,0,0.4); }
        .leaflet-control-zoom-in, .leaflet-control-zoom-out { font-size: 18px !important; padding: 5px 8px !important; line-height: 1.2 !important; }
        
        #settingsModal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.95);
            color: var(--color-text); z-index: 1001; display: none; padding: 20px; overflow-y: auto; box-sizing: border-box;
        }
        
        #settingsModal h2 { border-bottom: 1px solid #444; padding-bottom: 10px; margin-top: 0; }
        #settingsModal .close-button { position: absolute; top: 10px; right: 20px; font-size: 24px; cursor: pointer; }
        
        .setting-group {
            margin-bottom: 25px; padding: 10px; background: #222; border-radius: 8px;
        }

        .setting-item {
            display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dashed #333;
        }
        .setting-item:last-child { border-bottom: none; }
        .setting-item label { flex-grow: 1; }
        .setting-item input[type="number"], .setting-item select {
            width: 70px; background: #333; border: none; color: var(--color-text);
            padding: 5px; border-radius: 4px; text-align: right;
        }
        
        .switch {
            position: relative; display: inline-block; width: 40px; height: 24px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 24px;
        }
        .slider:before {
            position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--color-success); }
        input:focus + .slider { box-shadow: 0 0 1px var(--color-success); }
        input:checked + .slider:before { transform: translateX(16px); }

        .file-controls {
            display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
        }
        .file-controls input[type="file"] { display: none; }
        .file-controls button {
            background: #555; color: white; padding: 8px 15px; border: none; border-radius: 4px;
            cursor: pointer; transition: background 0.2s;
        }
        .file-controls button:hover { background: #777; }
        
        /* 3. GELİŞTİRME: YÜKSEKLİK GÖSTERGESİ */
        #altitudeDisplay {
            position: absolute; 
            left: 10px; 
            bottom: 10px; 
            z-index: 999; 
            background: rgba(17, 17, 17, 0.8); 
            color: var(--color-text); 
            padding: 8px 12px; 
            border-radius: 4px;
            font-size: 14px;
            display: none; /* Varsayılan olarak gizli */
        }
        /* Rota maliyet özeti için */
        #routeSummary {
            margin-top: 10px; 
            padding: 10px; 
            background: rgba(0, 0, 0, 0.5); 
            border-radius: 4px; 
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div id="controls">
        <div id="controls-inputs">
            <div id="durak-listesi" style="width: 100%; display: flex; flex-direction: column; gap: 5px;">
                <label>Başlangıç:
                    <div class="durak-item">
                        <input id="startInput" type="text" placeholder="Örn: Pendik, İstanbul" />
                        <button class="location-button" id="useStartLocBtn" title="Mevcut Konumumu Kullan"><i class="fas fa-crosshairs"></i></button>
                    </div>
                </label>
                <div id="araDuraklarContainer">
                    </div>
                <label>Bitiş:
                    <div class="durak-item">
                        <input id="endInput" type="text" placeholder="Örn: Milas, Muğla" />
                    </div>
                </label>
            </div>
            <button id="addDurakBtn"><i class="fas fa-plus-circle"></i> Ara Durak Ekle</button>
            <label>Çıkış saati (Şimdi):
                <input id="departureInput" type="datetime-local" /> 
            </label>
        </div>
        
        <div id="controls-buttons">
            <button id="routeBtn"><i class="fas fa-motorcycle"></i> Rota Çiz</button>
            <button id="clearBtn"><i class="fas fa-trash-alt"></i> Temizle / Yeni Rota</button>
            <button id="trackBtn"><i class="fas fa-location-arrow"></i> Konum Takibi</button>
            <button id="settingsBtn" title="Ayarlar"><i class="fas fa-cog"></i></button>
        </div>
        
        <div id="status-container">
            <span id="status">Harita hazırlanıyor...</span>
        </div>
        
        <div id="routeSummary" style="display:none;"></div>
    </div>
    
    <button id="mapToggleBtn" title="Harita/Uydu Görüntüsü Geçişi">
        <i class="fas fa-satellite"></i> Uydu Görünümü
    </button>
    
    <div id="poiControls">
        <div style="color:#ccc; font-size:12px; font-weight:bold; margin-bottom:5px;">İLGİ ÇEKİCİ NOKTALAR</div>
        <button id="poiFuelBtn" class="poi-button" data-poi-type="fuel"><i class="fas fa-gas-pump"></i> Benzin İstasyonları</button>
        <button id="poiLodgingBtn" class="poi-button" data-poi-type="lodging"><i class="fas fa-bed"></i> Konaklama Yerleri</button>
    </div>
    
    <div id="speedometer" class="hidden">
        <div id="currentSpeed">0 <small>km/s</small></div>
        <div id="speedLimit">Limit: - km/s</div>
    </div>
    <div id="altitudeDisplay">Yükseklik: - m</div>
    
    <div id="settingsModal">
        <div class="close-button" id="closeSettingsBtn">×</div>
        <h2><i class="fas fa-cog"></i> Uygulama Ayarları</h2>
        
        <div class="setting-group">
            <h3><i class="fas fa-moon"></i> Uygulama Görünümü</h3>
            <div class="setting-item">
                <label for="darkModeToggle">Karanlık Modu (Gece Modu) Aktif Et</label>
                <label class="switch">
                    <input type="checkbox" id="darkModeToggle">
                    <span class="slider round"></span>
                </label>
            </div>
        </div>
        
        <div class="setting-group">
             <h3><i class="fas fa-chart-area"></i> Ekstra Göstergeler</h3>
            <div class="setting-item">
                <label for="altitudeDisplayToggle">Yükseklik Bilgisini Göster</label>
                <label class="switch">
                    <input type="checkbox" id="altitudeDisplayToggle">
                    <span class="slider round"></span>
                </label>
            </div>
        </div>
        
        <div class="setting-group">
            <h3><i class="fas fa-coffee"></i> Mola Planlama (2. Geliştirme)</h3>
            <div class="setting-item">
                <label for="molaToggle">Mola Hatırlatmasını Aktif Et</label>
                <label class="switch">
                    <input type="checkbox" id="molaToggle">
                    <span class="slider round"></span>
                </label>
            </div>
            <div class="setting-item" id="molaFrekansAyari" style="display:none;">
                <label>Frekans: Her</label>
                <input type="number" id="molaFrekansDeger" value="3" min="1" />
                <select id="molaFrekansTip">
                    <option value="saat">Saat</option>
                    <option value="km">Km</option>
                </select>
                <small style="margin-left: 10px;"> bir mola</small>
            </div>
        </div>

        <div class="setting-group">
            <h3><i class="fas fa-route"></i> Rota Tercihleri (5. Geliştirme)</h3>
            <div class="setting-item">
                <label for="avoidTollsToggle">Ücretli Yollardan Kaçın</label>
                <label class="switch">
                    <input type="checkbox" id="avoidTollsToggle">
                    <span class="slider round"></span>
                </label>
            </div>
             <div class="setting-item">
                <label for="avoidFerriesToggle">Feribotlardan Kaçın</label>
                <label class="switch">
                    <input type="checkbox" id="avoidFerriesToggle">
                    <span class="slider round"></span>
                </label>
            </div>
            </div>

        <div class="setting-group">
             <h3><i class="fas fa-gas-pump"></i> Maliyet Hesaplama</h3>
            <div class="setting-item">
                <label for="yakitTuketimi">Ort. Yakıt Tüketimi (Lt/100 km):</label>
                <input type="number" id="yakitTuketimi" step="0.1" min="1" value="8.0" />
            </div>
            <div class="setting-item">
                <label for="yakitFiyati">Ort. Yakıt Fiyatı (TL/Lt):</label>
                <input type="number" id="yakitFiyati" step="0.1" min="1" value="40.0" />
            </div>
        </div>
        
        <div class="setting-group">
            <h3><i class="fas fa-database"></i> Risk Eşikleri</h3>
            <div class="setting-item">
                <label for="warnWind">Orta Risk Rüzgar Hızı (km/s):</label>
                <input type="number" id="warnWind" min="1" max="100" />
            </div>
            <div class="setting-item">
                <label for="dangerWind">Yüksek Risk Rüzgar Hızı (km/s):</label>
                <input type="number" id="dangerWind" min="1" max="100" />
            </div>
            <div class="setting-item">
                <label for="warnPrecip">Orta Risk Yağış (mm/saat):</label>
                <input type="number" id="warnPrecip" step="0.1" min="0" max="10" />
            </div>
            <div class="setting-item">
                <label for="dangerPrecip">Yüksek Risk Yağış (mm/saat):</label>
                <input type="number" id="dangerPrecip" step="0.1" min="0" max="10" />
            </div>
        </div>
        
        <div class="setting-group">
            <h3><i class="fas fa-exchange-alt"></i> Rota İçe/Dışa Aktarma (GPX/KML)</h3>
            <div style="margin-bottom: 15px;">
                <label for="importFile" style="font-size: 14px; margin-bottom: 5px; display: block;">GPX/KML Dosyası İçe Aktar:</label>
                <div class="file-controls">
                    <input type="file" id="importFile" accept=".gpx, .kml" />
                    <button onclick="document.getElementById('importFile').click()"><i class="fas fa-upload"></i> Dosya Seç</button>
                    <button id="importBtn" disabled><i class="fas fa-map-marked-alt"></i> Haritada Göster</button>
                </div>
            </div>
            <div>
                <label style="font-size: 14px; margin-bottom: 5px; display: block;">Son Çizilen Rotayı Dışa Aktar:</label>
                <div class="file-controls">
                    <button id="exportGPXBtn" disabled><i class="fas fa-file-export"></i> GPX Olarak İndir</button>
                    <button id="exportKMLBtn" disabled><i class="fas fa-file-export"></i> KML Olarak İndir</button>
                </div>
            </div>
        </div>
        
        <div class="setting-group">
            <h3><i class="fas fa-database"></i> Veri Yönetimi</h3>
            <div class="setting-item">
                <label for="saveRouteToggle">Rota Verilerini Cihazımda Kaydet (Son Rotayı Hatırla)</label>
                <label class="switch">
                    <input type="checkbox" id="saveRouteToggle">
                    <span class="slider round"></span>
                </label>
            </div>
        </div>
        
    </div>
    
    <div id="map"></div>

    <script
        src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""
    ></script>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script>
        // --- Sabitler ve Ayarlar ---
        let DANGER_WIND = 40; 
        let WARNING_WIND = 25; 
        let DANGER_PRECIP = 2; 
        let WARNING_PRECIP = 0.1; 
        let SHOULD_SAVE_ROUTE = false;
        
        let CURRENT_THEME = 'dark-mode'; // Varsayılan: Karanlık Mod/Gece Modu (1. Geliştirme)
        let ALTITUDE_DISPLAY_ACTIVE = false; // Varsayılan: Kapalı (3. Geliştirme)
        
        // 5. Rota Tercih Filtreleri
        let AVOID_TOLLS = false; 
        let AVOID_FERRIES = false; 
        let OSRM_PROFILE = 'driving'; 
        
        // 4. Maliyet Hesaplama Parametreleri
        let YAKIT_TUKETIMI = 8.0; // Lt/100km
        let YAKIT_FIYATI = 40.0; // TL/Lt
        
        // 2. Mola Planlama Parametreleri
        let MOLA_AKTIF = false; 
        let MOLA_FREKANSI_TIP = 'saat'; // 'km' veya 'saat'
        let MOLA_FREKANSI_DEGER = 3; 
        const VARSAYILAN_MOLA_SURESI_DK = 20;

        const MIN_SEGMENT_DISTANCE_KM = 10; 
        const MIN_SAMPLE_COUNT = 10; 
        const POI_SEARCH_BUFFER_KM = 2; 

        // --- Global Değişkenler ---
        let lastRouteGeoJSON = null; 
        let importedRouteLayer = L.layerGroup(); 
        let currentMapType = 'osm'; 
        
        // 6. Çoklu Durak Yönetimi
        let durakKonumlari = []; 

        const poiLayerGroups = {
            fuel: L.layerGroup(),
            lodging: L.layerGroup(),
        };
        
        // --- Harita Katmanları ---
        const osmLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 18,
            attribution: '© OSM & OSRM & Open-Meteo',
        });
        
        const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '© CartoDB'
        });
        
        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles © Esri — Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });

        // --- Haritayı başlat ---
        const map = L.map("map", { zoomControl: false, layers: [osmLayer] }); 
        importedRouteLayer.addTo(map); 
        Object.values(poiLayerGroups).forEach(layer => layer.addTo(map));


        let customLegend = null; 
        
        const controlsEl = document.getElementById("controls");
        const routeLayerGroup = L.layerGroup().addTo(map);
        const weatherLayerGroup = L.layerGroup().addTo(map);
        
        const poiControlsEl = document.getElementById('poiControls'); 
        const poiButtons = {
            fuel: document.getElementById('poiFuelBtn'),
            lodging: document.getElementById('poiLodgingBtn')
        };
        
        // DOM Elementleri
        const warnWindInput = document.getElementById('warnWind');
        const dangerWindInput = document.getElementById('dangerWind');
        const warnPrecipInput = document.getElementById('warnPrecip');
        const dangerPrecipInput = document.getElementById('dangerPrecip');
        const saveRouteToggle = document.getElementById('saveRouteToggle');
        const exportGPXBtn = document.getElementById('exportGPXBtn');
        const exportKMLBtn = document.getElementById('exportKMLBtn');
        const importFile = document.getElementById('importFile');
        const importBtn = document.getElementById('importBtn');
        const clearBtn = document.getElementById('clearBtn'); 
        const statusEl = document.getElementById("status");
        const routeBtn = document.getElementById("routeBtn");
        const trackBtn = document.getElementById("trackBtn");
        const settingsBtn = document.getElementById("settingsBtn");
        const settingsModal = document.getElementById("settingsModal");
        const closeSettingsBtn = document.getElementById("closeSettingsBtn");
        const useStartLocBtn = document.getElementById("useStartLocBtn");
        const startInput = document.getElementById("startInput");
        
        // Yeni V3 Elementleri
        const mapToggleBtn = document.getElementById('mapToggleBtn');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const altitudeDisplayToggle = document.getElementById('altitudeDisplayToggle');
        const altitudeDisplayEl = document.getElementById('altitudeDisplay');
        const speedometerEl = document.getElementById('speedometer');
        const currentSpeedEl = document.getElementById('currentSpeed');
        const speedLimitEl = document.getElementById('speedLimit');
        const routeSummaryEl = document.getElementById('routeSummary');
        const avoidTollsToggle = document.getElementById('avoidTollsToggle');
        const avoidFerriesToggle = document.getElementById('avoidFerriesToggle');
        const yakitTuketimiInput = document.getElementById('yakitTuketimi');
        const yakitFiyatiInput = document.getElementById('yakitFiyati');
        const molaToggle = document.getElementById('molaToggle');
        const molaFrekansAyariEl = document.getElementById('molaFrekansAyari');
        const molaFrekansDegerInput = document.getElementById('molaFrekansDeger');
        const molaFrekansTipSelect = document.getElementById('molaFrekansTip');
        const addDurakBtn = document.getElementById('addDurakBtn');
        const araDuraklarContainer = document.getElementById('araDuraklarContainer');
        const endInput = document.getElementById("endInput"); 

        let trackingMarker = null;
        let watchId = null; 
        
        // 6. GELİŞTİRME: Durak Yönetimi için SortableJS başlatma
        new Sortable(araDuraklarContainer, {
            animation: 150,
            handle: '.drag-handle',
            onEnd: function (evt) {
                // Sürükle bırak sonrası rotayı yeniden hesapla
            }
        });

        // 6. GELİŞTİRME: Ara Durak Ekleme Butonu
        addDurakBtn.addEventListener('click', () => {
            const index = araDuraklarContainer.children.length;
            const newDurakId = `durakInput${index}`;
            const durakDiv = document.createElement('label');
            durakDiv.innerHTML = `
                <div class="durak-item" data-index="${index}">
                    <span class="drag-handle"><i class="fas fa-grip-vertical"></i></span>
                    <input id="${newDurakId}" type="text" placeholder="Ara Durak ${index + 1}" />
                    <button class="remove-durak-btn" title="Kaldır"><i class="fas fa-times"></i></button>
                </div>
            `;
            araDuraklarContainer.appendChild(durakDiv);
            durakDiv.querySelector('.remove-durak-btn').addEventListener('click', (e) => {
                e.preventDefault();
                durakDiv.closest('label').remove();
            });
        });


        // --- YEREL DEPOLAMA ve İLK YÜKLEME ---
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('motoAppSettings'));
            if (settings) {
                DANGER_WIND = settings.dangerWind || DANGER_WIND;
                WARNING_WIND = settings.warnWind || WARNING_WIND;
                DANGER_PRECIP = settings.dangerPrecip || DANGER_PRECIP;
                WARNING_PRECIP = settings.warnPrecip || WARNING_PRECIP;
                SHOULD_SAVE_ROUTE = settings.shouldSaveRoute || false;
                
                // V3 Ayarları
                CURRENT_THEME = settings.currentTheme || CURRENT_THEME;
                ALTITUDE_DISPLAY_ACTIVE = settings.altitudeDisplayActive || ALTITUDE_DISPLAY_ACTIVE;
                AVOID_TOLLS = settings.avoidTolls || AVOID_TOLLS;
                AVOID_FERRIES = settings.avoidFerries || AVOID_FERRIES;
                YAKIT_TUKETIMI = settings.yakitTuketimi || YAKIT_TUKETIMI;
                YAKIT_FIYATI = settings.yakitFiyati || YAKIT_FIYATI;
                MOLA_AKTIF = settings.molaAktif || MOLA_AKTIF;
                MOLA_FREKANSI_TIP = settings.molaFrekansTip || MOLA_FREKANSI_TIP;
                MOLA_FREKANSI_DEGER = settings.molaFrekansDeger || MOLA_FREKANSI_DEGER;
            }
            
            applyTheme(CURRENT_THEME);
            updateAltitudeDisplay(); 
            fillSettingsInputs();
            
            if (SHOULD_SAVE_ROUTE) {
                const lastRoute = localStorage.getItem('lastRouteGeoJSON');
                if (lastRoute) {
                    lastRouteGeoJSON = JSON.parse(lastRoute);
                    setStatus("Önceki rota verisi yüklendi. Tekrar çizmek için Başlangıç/Bitiş'i kullanın.");
                    if (lastRouteGeoJSON.features && lastRouteGeoJSON.features[0].geometry) {
                        L.geoJSON(lastRouteGeoJSON, { style: { color: '#00ccff', weight: 6, opacity: 0.5 } }).addTo(routeLayerGroup);
                        const allCoords = getLatLngCoords(lastRouteGeoJSON.features[0].geometry);
                        if (allCoords.length > 0) map.fitBounds(L.polyline(allCoords).getBounds(), { padding: [80, 80] });
                        controlsEl.classList.add('minimized'); 
                    }
                }
            }
            updateExportButtons();
        }
        
        function saveSettings() {
            const settings = {
                warnWind: WARNING_WIND,
                dangerWind: DANGER_WIND,
                warnPrecip: WARNING_PRECIP,
                dangerPrecip: DANGER_PRECIP,
                shouldSaveRoute: SHOULD_SAVE_ROUTE,
                // V3 Ayarları
                currentTheme: CURRENT_THEME,
                altitudeDisplayActive: ALTITUDE_DISPLAY_ACTIVE,
                avoidTolls: AVOID_TOLLS,
                avoidFerries: AVOID_FERRIES,
                yakitTuketimi: YAKIT_TUKETIMI,
                yakitFiyati: YAKIT_FIYATI,
                molaAktif: MOLA_AKTIF,
                molaFrekansTip: MOLA_FREKANSI_TIP,
                molaFrekansDeger: MOLA_FREKANSI_DEGER,
            };
            localStorage.setItem('motoAppSettings', JSON.stringify(settings));
        }

        function updateExportButtons() {
            const isDisabled = lastRouteGeoJSON === null;
            exportGPXBtn.disabled = isDisabled;
            exportKMLBtn.disabled = isDisabled;
            poiControlsEl.style.display = isDisabled ? 'none' : 'flex';
        }

        function updateLegend() {
            if (customLegend) {
                map.removeControl(customLegend);
            }
            
            customLegend = L.control({ position: "bottomright" });
            customLegend.onAdd = function () {
                const div = L.DomUtil.create("div", "legend");
                // Harita temasını yansıtması için stil eklendi
                div.style.background = CURRENT_THEME === 'light-mode' ? 'rgba(255, 255, 255, 0.8)' : 'rgba(17, 17, 17, 0.8)';
                div.style.color = CURRENT_THEME === 'light-mode' ? '#333' : '#eee';
                div.innerHTML = `
                    <b>ROTA VE MARKER RİSK</b>
                    <div><span style="background:var(--color-danger)"></span> Yüksek Risk (> ${DANGER_WIND} km/s VEYA > ${DANGER_PRECIP} mm)</div>
                    <div><span style="background:var(--color-warning)"></span> Orta Risk (> ${WARNING_WIND} km/s VEYA > ${WARNING_PRECIP} mm)</div>
                    <div><span style="background:var(--color-success)"></span> Düşük Risk (İyi)</div>
                `;
                return div;
            };
            customLegend.addTo(map);
        }

        function fillSettingsInputs() {
            warnWindInput.value = WARNING_WIND;
            dangerWindInput.value = DANGER_WIND;
            warnPrecipInput.value = WARNING_PRECIP;
            dangerPrecipInput.value = DANGER_PRECIP;
            saveRouteToggle.checked = SHOULD_SAVE_ROUTE;
            
            // V3 Ayarları dolduruluyor
            darkModeToggle.checked = CURRENT_THEME === 'dark-mode';
            altitudeDisplayToggle.checked = ALTITUDE_DISPLAY_ACTIVE;
            avoidTollsToggle.checked = AVOID_TOLLS;
            avoidFerriesToggle.checked = AVOID_FERRIES;
            yakitTuketimiInput.value = YAKIT_TUKETIMI;
            yakitFiyatiInput.value = YAKIT_FIYATI;
            molaToggle.checked = MOLA_AKTIF;
            molaFrekansTipSelect.value = MOLA_FREKANSI_TIP;
            molaFrekansDegerInput.value = MOLA_FREKANSI_DEGER;
            
            // Mola ayarını görünür yap
            molaFrekansAyariEl.style.display = MOLA_AKTIF ? 'flex' : 'none';
        }

        function setInitialMapView() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        map.setView([pos.coords.latitude, pos.coords.longitude], 10);
                        setStatus("Konumunuz bulundu, harita hazır.");
                    },
                    (err) => {
                        map.setView([39.0, 35.0], 6); 
                        setStatus("Harita hazır. Başlangıç ve bitiş giriniz.");
                    },
                    { enableHighAccuracy: false, timeout: 5000 }
                );
            } else {
                map.setView([39.0, 35.0], 6); 
                setStatus("Harita hazır. Başlangıç ve bitiş giriniz.");
            }
        }
        
        // 1. GELİŞTİRME ve HATA DÜZELTMESİ: Karanlık Mod / Gece Modu Uygulama
        function applyTheme(theme) {
            document.body.classList.remove('dark-mode', 'light-mode');
            
            // Mevcut temayı yansıtan CSS sınıfını ayarla
            if (theme === 'dark-mode') {
                document.body.classList.add('dark-mode');
            } else {
                 document.body.classList.add('light-mode');
            }
            
            // Harita katmanını adapte et
            if (currentMapType !== 'satellite') { // Uydu modu aktif değilse temel katmanı değiştir
                if (map.hasLayer(osmLayer)) map.removeLayer(osmLayer);
                if (map.hasLayer(darkLayer)) map.removeLayer(darkLayer);
                
                if (theme === 'dark-mode') {
                    map.addLayer(darkLayer);
                    currentMapType = 'dark';
                    mapToggleBtn.innerHTML = '<i class="fas fa-sun"></i> Aydınlık Görünüm';
                } else {
                    map.addLayer(osmLayer);
                    currentMapType = 'osm';
                    mapToggleBtn.innerHTML = '<i class="fas fa-satellite"></i> Uydu Görünümü';
                }
            } 
            
            // Uydu modundayken bile buton metnini güncelle
            if (currentMapType === 'satellite') {
                 mapToggleBtn.innerHTML = theme === 'dark-mode' ? 
                    '<i class="fas fa-map"></i> Harita Görünümü (Karanlık)' : 
                    '<i class="fas fa-map"></i> Harita Görünümü (Aydınlık)';
            }
            
            CURRENT_THEME = theme;
            updateLegend(); // Efsanenin rengini güncelle
        }
        
        // 3. GELİŞTİRME: Yükseklik göstergesini güncelleme
        function updateAltitudeDisplay() {
            altitudeDisplayEl.style.display = ALTITUDE_DISPLAY_ACTIVE ? 'block' : 'none';
        }

        loadSettings(); 
        setInitialMapView();
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // --- Harita Katman Geçişi (Standart/Uydu/Gece) ---
        function toggleMapLayer() {
            if (currentMapType === 'osm' || currentMapType === 'dark') {
                // Standart veya Karanlıktan Uyduya geç
                if (map.hasLayer(osmLayer)) map.removeLayer(osmLayer);
                if (map.hasLayer(darkLayer)) map.removeLayer(darkLayer);
                map.addLayer(satelliteLayer);
                currentMapType = 'satellite';
                mapToggleBtn.innerHTML = '<i class="fas fa-map"></i> Harita Görünümü';
            } else if (currentMapType === 'satellite') {
                // Uydudan temaya (Karanlık/Aydınlık moduna) geri dön
                map.removeLayer(satelliteLayer);
                
                if (CURRENT_THEME === 'dark-mode') {
                    map.addLayer(darkLayer);
                    currentMapType = 'dark';
                    mapToggleBtn.innerHTML = '<i class="fas fa-sun"></i> Aydınlık Görünüm';
                } else {
                    map.addLayer(osmLayer);
                    currentMapType = 'osm';
                    mapToggleBtn.innerHTML = '<i class="fas fa-satellite"></i> Uydu Görünümü';
                }
            }
        }
        mapToggleBtn.addEventListener('click', toggleMapLayer);
        darkModeToggle.addEventListener('change', () => applyTheme(darkModeToggle.checked ? 'dark-mode' : 'light-mode'));
        altitudeDisplayToggle.addEventListener('change', () => { ALTITUDE_DISPLAY_ACTIVE = altitudeDisplayToggle.checked; updateAltitudeDisplay(); });
        molaToggle.addEventListener('change', () => { MOLA_AKTIF = molaToggle.checked; molaFrekansAyariEl.style.display = MOLA_AKTIF ? 'flex' : 'none'; });
        
        // --- POI ARAMA İŞLEVLERİ (Aynı kalır) ---
        function buildOverpassQuery(poiType, routeGeoJSON, bufferKm) {
            if (!routeGeoJSON || !routeGeoJSON.features || routeGeoJSON.features.length === 0) return null;

            const coords = routeGeoJSON.features[0].geometry.coordinates;
            const points = coords.filter((_, i) => i % 10 === 0 || i === coords.length - 1);

            let query = `[out:json][timeout:30];\n`;
            
            let osmKeys;
            switch(poiType) {
                case 'fuel':
                    osmKeys = `node["amenity"="fuel"](around:${bufferKm * 1000}, {lat}, {lon});\n`;
                    break;
                case 'lodging':
                    osmKeys = `node["tourism"~"hotel|motel|guest_house|hostel"](around:${bufferKm * 1000}, {lat}, {lon});\n`;
                    break;
                case 'rest_area': 
                    osmKeys = `node["highway"~"rest_area|services"](around:${bufferKm * 1000}, {lat}, {lon});\n`;
                    break;
                default:
                    return null;
            }

            points.forEach(c => {
                const lon = c[0];
                const lat = c[1];
                query += osmKeys.replace(/{lat}/g, lat).replace(/{lon}/g, lon);
            });
            
            query += `out center;`;
            
            return query;
        }

        async function fetchAndDisplayPOIs(poiType) {
            if (!lastRouteGeoJSON) {
                setStatus("Önce bir rota çizmelisiniz.");
                poiButtons[poiType].classList.remove('active');
                return;
            }

            const layerGroup = poiLayerGroups[poiType];
            
            if (layerGroup.getLayers().length > 0) {
                 layerGroup.clearLayers();
                 setStatus(`${poiType} POI'leri haritadan kaldırıldı.`);
                 return;
            }
            
            setStatus(`${poiType} POI'leri aranıyor...`);
            
            const query = buildOverpassQuery(poiType, lastRouteGeoJSON, POI_SEARCH_BUFFER_KM);
            if (!query) {
                setStatus("POI sorgusu oluşturulamadı.");
                return;
            }
            
            const url = "https://overpass-api.de/api/interpreter";

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: `data=${encodeURIComponent(query)}`
                });
                
                if (!response.ok) throw new Error(`Overpass API hatası: ${response.status}`);
                
                const data = await response.json();
                
                let iconName, iconColor;
                switch(poiType) {
                    case 'fuel':
                        iconName = 'fas fa-gas-pump';
                        iconColor = 'orange';
                        break;
                    case 'lodging':
                        iconName = 'fas fa-bed';
                        iconColor = 'purple';
                        break;
                    default:
                        iconName = 'fas fa-map-marker-alt';
                        iconColor = 'blue';
                }
                
                const poiIcon = L.divIcon({
                    className: 'poi-icon',
                    html: `<div style="color: ${iconColor}; font-size: 24px;"><i class="${iconName}"></i></div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 24]
                });

                let count = 0;
                data.elements.forEach(el => {
                    if (el.type === 'node') {
                        const lat = el.lat;
                        const lon = el.lon;
                        const name = el.tags.name || 'İsimsiz Yer';
                        const type = el.tags.amenity || el.tags.tourism || poiType;

                        L.marker([lat, lon], { icon: poiIcon })
                            .bindPopup(`<b>${name}</b><br/>Tip: ${type}<br/><a href="http://maps.google.com/maps?q=${lat},${lon}" target="_blank">Google Haritalar'da Aç</a>`)
                            .addTo(layerGroup);
                        count++;
                    }
                });

                setStatus(`${poiType} için ${count} adet POI bulundu.`);
                
            } catch (error) {
                console.error("POI çekme hatası:", error);
                setStatus(`POI arama hatası: ${error.message}`);
            }
        }
        
        Object.keys(poiButtons).forEach(poiType => {
            poiButtons[poiType].addEventListener('click', async () => {
                const btn = poiButtons[poiType];
                
                if (btn.classList.contains('active')) {
                    poiLayerGroups[poiType].clearLayers();
                    btn.classList.remove('active');
                    setStatus(`${poiType} POI'leri kapatıldı.`);
                } else {
                    btn.classList.add('active');
                    await fetchAndDisplayPOIs(poiType);
                    
                    if (poiLayerGroups[poiType].getLayers().length === 0) {
                        btn.classList.remove('active');
                    }
                }
            });
        });

        // --- TEMİZLEME İŞLEVİ ---
        function clearMapAndResetControls() {
            routeLayerGroup.clearLayers();
            weatherLayerGroup.clearLayers();
            importedRouteLayer.clearLayers();
            
            Object.values(poiLayerGroups).forEach(layer => layer.clearLayers());
            Object.values(poiButtons).forEach(btn => btn.classList.remove('active'));
            poiControlsEl.style.display = 'none';
            routeSummaryEl.style.display = 'none';
            speedometerEl.classList.add('hidden');
            
            // 6. GELİŞTİRME: Durakları temizle
            araDuraklarContainer.innerHTML = '';
            
            lastRouteGeoJSON = null;
            
            if (watchId) toggleGeolocation(); 
            
            controlsEl.classList.remove('minimized');
            updateExportButtons();
            
            setStatus("Harita temizlendi. Yeni başlangıç ve bitiş giriniz.");
            setInitialMapView(); 
        }
        
        clearBtn.addEventListener('click', clearMapAndResetControls);


        // --- DİĞER FONKSİYONLAR ---
        function setStatus(msg) { statusEl.textContent = msg || ""; }
        function setLoading(loading) {
            routeBtn.disabled = loading;
            const icon = loading ? 'fa-spinner fa-spin' : 'fa-motorcycle';
            routeBtn.innerHTML = `<i class="fas ${icon}"></i> ${loading ? "Hesaplanıyor..." : "Rota Çiz"}`;
        }
        function getWeatherRisk(info) {
            const { precipitation, wind } = info;
            if (precipitation > DANGER_PRECIP || wind >= DANGER_WIND) { return 3; }
            if (precipitation > WARNING_PRECIP || wind >= WARNING_WIND) { return 2; }
            return 1; 
        }
        function getRiskColor(riskLevel) {
            switch (riskLevel) {
                case 3: return "#f44336"; 
                case 2: return "#ff9800"; 
                default: return "#4caf50"; 
            }
        }
        function getRiskIcon(info) {
             const { precipitation, wind } = info;
             let icon = '';
             if (wind >= WARNING_WIND) icon += '<i class="fas fa-wind"></i>';
             if (precipitation > WARNING_PRECIP) icon += '<i class="fas fa-cloud-showers-heavy"></i>';
             return icon || '<i class="fas fa-sun"></i>';
        }
        async function geocode(query) {
            const url = "https://nominatim.openstreetmap.org/search?format=json&limit=1&q=" + encodeURIComponent(query);
            const res = await fetch(url, { headers: { "Accept-Language": "tr" } });
            if (!res.ok) throw new Error("Konum sorgulama başarısız: " + res.status);
            const data = await res.json();
            if (!data || data.length === 0) throw new Error("Konum bulunamadı: " + query);
            const item = data[0];
            return { lat: parseFloat(item.lat), lon: parseFloat(item.lon), display_name: item.display_name };
        }
        async function reverseGeocode(lat, lon) {
             const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`;
             const res = await fetch(url, { headers: { "Accept-Language": "tr" } });
             if (!res.ok) return `${lat.toFixed(4)}, ${lon.toFixed(4)}`; 
             const data = await res.json();
             return data.display_name || `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
        }
        async function getRoute(waypoints) {
            if (waypoints.length < 2) throw new Error("Rota için en az iki nokta (Başlangıç ve Bitiş) gereklidir.");
            
            let osrmService = "driving";
            let osrmOptions = ''; 

            let coordinates = waypoints.map(w => [w.lon, w.lat].join(",")).join(";");
            
            const url = `https://router.project-osrm.org/route/v1/${osrmService}/${coordinates}?overview=full&geometries=geojson${osrmOptions}`;
            
            const res = await fetch(url);
            if (!res.ok) throw new Error("Rota isteği başarısız: " + res.status);
            const data = await res.json();
            if (!data.routes || data.routes.length === 0) throw new Error("Rota bulunamadı.");
            return data.routes[0];
        }
        function getLatLngCoords(geometry) {
            return geometry.coordinates.map((c) => [c[1], c[0]]); 
        }
        
        // HATA DÜZELTMESİ: Hava Durumu API Hata Yönetimi
        async function getHourlyWeather(lat, lon) {
            // Kontrol: Latitude ve Longitude değerlerinin sayı olduğundan emin ol (400 hatasını önler)
            const latitude = parseFloat(lat);
            const longitude = parseFloat(lon);
            
            if (isNaN(latitude) || isNaN(longitude)) {
                 throw new Error("Geçersiz koordinatlar.");
            }

            const url = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&hourly=temperature_2m,precipitation,wind_speed_10m,elevation&forecast_days=7&timezone=auto`;
            
            const res = await fetch(url);
            // Hata mesajını daha spesifik hale getirme
            if (!res.ok) {
                 const errorText = await res.text();
                 throw new Error(`Hava isteği başarısız: ${res.status} - Detay: ${errorText.substring(0, 50)}...`);
            }
            const data = await res.json();
            if (!data.hourly || !data.hourly.time) throw new Error("Saatlik hava verisi bulunamadı.");
            return data.hourly;
        }
        
        function findNearestHourIndex(times, targetDate) {
            let bestIdx = 0;
            let bestDiff = Infinity;
            for (let i = 0; i < times.length; i++) {
                const t = new Date(times[i]);
                const diff = Math.abs(t - targetDate);
                if (diff < bestDiff) {
                    bestDiff = diff;
                    bestIdx = i;
                }
            }
            return bestIdx;
        }
        
        // 4. GELİŞTİRME: Yolculuk Maliyetini Hesaplama
        function calculateCosts(distanceKm, durationMinutes) {
            const totalLitres = (distanceKm / 100) * YAKIT_TUKETIMI;
            const yakitMaliyeti = totalLitres * YAKIT_FIYATI;
            
            let gecisUcreti = 0;
            if (!AVOID_TOLLS && distanceKm > 500) {
                gecisUcreti = 120; 
            } else if (!AVOID_TOLLS && distanceKm > 100) {
                 gecisUcreti = 30; 
            }
            
            return { gecisUcreti: gecisUcreti, yakitMaliyeti: yakitMaliyeti };
        }
        
        // 2. GELİŞTİRME: Mola Süresini Hesaplama
        function calculateMolaDuration(distanceKm, durationMinutes) {
            if (!MOLA_AKTIF) return 0;
            
            let frekansBase = 0;
            if (MOLA_FREKANSI_TIP === 'km') {
                frekansBase = distanceKm / MOLA_FREKANSI_DEGER;
            } else { // 'saat'
                frekansBase = durationMinutes / 60 / MOLA_FREKANSI_DEGER;
            }
            
            const molaSayisi = Math.floor(frekansBase);
            const eklenenMolaSuresi = molaSayisi * VARSAYILAN_MOLA_SURESI_DK;
            
            if (molaSayisi > 0) {
                console.log(`Otomatik Mola Planı: ${molaSayisi} mola eklendi. Toplam süreye ${eklenenMolaSuresi} dakika eklendi.`);
            }
            
            return eklenenMolaSuresi;
        }
        
        // 6. GELİŞTİRME: Durak Inputlarını Toplama
        function collectWaypoints() {
            const waypoints = [];
            
            // 1. Başlangıç Noktası
            waypoints.push({ id: 'start', input: startInput });

            // 2. Ara Duraklar
            const araDurakInputs = araDuraklarContainer.querySelectorAll('input');
            araDurakInputs.forEach((input, index) => {
                waypoints.push({ id: `mid-${index}`, input: input });
            });

            // 3. Bitiş Noktası
            waypoints.push({ id: 'end', input: endInput });
            
            return waypoints;
        }
        
        async function handleRoute() {
            controlsEl.classList.add('minimized');
            routeLayerGroup.clearLayers();
            weatherLayerGroup.clearLayers();
            importedRouteLayer.clearLayers(); 
            Object.values(poiLayerGroups).forEach(layer => layer.clearLayers());
            Object.values(poiButtons).forEach(btn => btn.classList.remove('active'));
            routeSummaryEl.style.display = 'none';

            const departureInput = document.getElementById("departureInput");
            const waypoints = collectWaypoints();
            const validWaypointInputs = waypoints.filter(w => w.input.value.trim() !== '');

            if (validWaypointInputs.length < 2) {
                 alert("Rota için en az Başlangıç ve Bitiş noktalarını yazmalısınız.");
                 controlsEl.classList.remove('minimized');
                 return;
            }
            
            let departureInputVal = departureInput.value;
            let departureTime = departureInputVal ? new Date(departureInputVal) : new Date();

            if (departureTime.toString() === "Invalid Date") {
                alert("Geçerli bir çıkış saati giriniz.");
                controlsEl.classList.remove('minimized');
                return;
            }
            
            setStatus("Konumlar çözümleniyor...");
            setLoading(true);

            try {
                // Tüm durakları coğrafi kodlama
                const geocodedWaypoints = await Promise.all(
                    validWaypointInputs.map(w => geocode(w.input.value.trim()))
                );
                
                // Rota çizimi
                setStatus("Rota hesaplanıyor...");
                const route = await getRoute(geocodedWaypoints);
                
                const totalDistanceMeters = route.distance;
                const totalDurationSec = route.duration;
                
                const allRouteCoords = getLatLngCoords(route.geometry);
                const totalPoints = allRouteCoords.length;

                // Markalama: Başlangıç, Bitiş ve Ara Duraklar
                const startIcon = L.icon({iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]});
                const endIcon = L.icon({iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]});
                const midIcon = L.icon({iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]});

                geocodedWaypoints.forEach((wp, index) => {
                    let icon = midIcon;
                    if (index === 0) icon = startIcon;
                    if (index === geocodedWaypoints.length - 1) icon = endIcon;
                    
                    L.marker([wp.lat, wp.lon], {icon: icon})
                        .addTo(routeLayerGroup)
                        .bindPopup(`<b>Durak ${index + 1}:</b> ${wp.display_name}`)
                        .openPopup();
                });
                
                // --- Rota Sonrası Hesaplamalar ---
                const totalDistanceKm = totalDistanceMeters / 1000;
                const totalDurationMinutes = totalDurationSec / 60;
                
                // 2. GELİŞTİRME: Mola Hesaplaması
                const molaSuresiDk = calculateMolaDuration(totalDistanceKm, totalDurationMinutes);
                
                // 4. GELİŞTİRME: Maliyet Hesaplaması
                const { gecisUcreti, yakitMaliyeti } = calculateCosts(totalDistanceKm, totalDurationMinutes);
                
                // Tahmini varış süresi (Trafik ve Mola dahil - Trafik simülasyonu 25 dk)
                const trafikGecikmesiDk = 25; 
                const tahminiVarisDk = totalDurationMinutes + molaSuresiDk + trafikGecikmesiDk;
                const tahminiVarisSaat = new Date(departureTime.getTime() + tahminiVarisDk * 60 * 1000);
                
                // --- Hava Durumu Risk Hesaplaması ---
                const requiredSegments = Math.ceil(totalDistanceMeters / (MIN_SEGMENT_DISTANCE_KM * 1000));
                const sampleCount = Math.max(MIN_SAMPLE_COUNT, requiredSegments); 
                const indices = [];
                for (let i = 0; i < sampleCount; i++) {
                    indices.push(Math.round(i / (sampleCount - 1) * (totalPoints - 1)));
                }
                
                setStatus(`Hava durumu (${sampleCount} nokta) ve segmentler belirleniyor...`);
                
                let lastRisk = 0;
                let segmentStartIdx = 0;
                let segmentResults = [];
                
                for (let i = 0; i < indices.length; i++) {
                    const currentRouteIdx = indices[i];
                    const currentCoords = allRouteCoords[currentRouteIdx];
                    const fraction = currentRouteIdx / (totalPoints - 1); 
                    const estimatedArrivalTime = new Date(
                        departureTime.getTime() + fraction * totalDurationSec * 1000
                    );
                    
                    const hourly = await getHourlyWeather(currentCoords[0], currentCoords[1]);
                    const idx = findNearestHourIndex(hourly.time, estimatedArrivalTime);
                    
                    const temp = hourly.temperature_2m[idx];
                    const precip = hourly.precipitation[idx];
                    const wind = hourly.wind_speed_10m[idx];
                    const elevation = hourly.elevation ? hourly.elevation[idx] : 'API Yok'; 
                    
                    const risk = getWeatherRisk({ precipitation: precip, wind }); 
                    const markerColor = getRiskColor(risk);
                    const riskIcons = getRiskIcon({ precipitation: precip, wind }); 
                    
                    const weatherIcon = L.divIcon({
                        className: 'weather-icon',
                        html: `<div style="color: ${markerColor}; font-size: 16px;">${riskIcons}</div>`,
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    });
                    
                    const marker = L.marker(currentCoords, {
                        icon: weatherIcon
                    }).bindPopup(`
                        <b>Varış:</b> ${estimatedArrivalTime.toLocaleString("tr-TR")}<br/>
                        <b>Risk Durumu:</b> ${riskIcons}<br/>
                        <b>Sıcaklık:</b> ${temp.toFixed(1)} °C<br/>
                        <b>Rüzgar:</b> ${wind.toFixed(1)} km/s<br/>
                        <b>Yağış:</b> ${precip.toFixed(2)} mm/saat<br/>
                        <b>Yükseklik:</b> ${elevation !== 'API Yok' ? Math.round(elevation) + ' m' : 'Bilgi Yok'}
                    `);
                    weatherLayerGroup.addLayer(marker);
                    
                    if (risk !== lastRisk && lastRisk !== 0) {
                        const segmentCoords = allRouteCoords.slice(segmentStartIdx, currentRouteIdx + 1);
                        segmentResults.push({ coords: segmentCoords, color: getRiskColor(lastRisk) });
                        segmentStartIdx = currentRouteIdx;
                    }
                    lastRisk = risk;
                    
                    if (i === indices.length - 1) {
                         const segmentCoords = allRouteCoords.slice(segmentStartIdx, allRouteCoords.length);
                         segmentResults.push({ coords: segmentCoords, color: getRiskColor(lastRisk) });
                    }
                }
                
                // Rota GeoJSON oluşturma
                const routeGeoJSON = {
                    type: "FeatureCollection",
                    features: [{
                        type: "Feature",
                        geometry: route.geometry,
                        properties: { name: "Moto Rota Hava Durumu - " + validWaypointInputs[0].input.value + " to " + validWaypointInputs[validWaypointInputs.length - 1].input.value }
                    }]
                };
                lastRouteGeoJSON = routeGeoJSON;
                updateExportButtons();
                if (SHOULD_SAVE_ROUTE) {
                    localStorage.setItem('lastRouteGeoJSON', JSON.stringify(lastRouteGeoJSON));
                } else {
                    localStorage.removeItem('lastRouteGeoJSON');
                }
                
                segmentResults.forEach(segment => {
                    const polyline = L.polyline(segment.coords, { color: segment.color, weight: 6, opacity: 0.8 });
                    routeLayerGroup.addLayer(polyline);
                });
                
                map.fitBounds(L.polyline(allRouteCoords).getBounds(), { padding: [80, 80] });
                
                // 4. GELİŞTİRME: Rota Özetini Gösterme
                routeSummaryEl.innerHTML = `
                    <i class="fas fa-info-circle"></i> <b>Rota Özeti:</b><br/>
                    Toplam Mesafe: <b>${totalDistanceKm.toFixed(0)} km</b><br/>
                    Toplam Süre (Mola/Trafik Dahil): <b>${(tahminiVarisDk / 60).toFixed(1)} saat</b><br/>
                    Tahmini Varış: <b>${tahminiVarisSaat.toLocaleTimeString("tr-TR")}</b><br/>
                    <hr style="margin: 5px 0; border-color: #333;">
                    <i class="fas fa-money-bill-wave"></i> Maliyet Tahmini:<br/>
                    Geçiş Ücreti: <b>${gecisUcreti.toFixed(2)} TL</b><br/>
                    Yakıt Maliyeti: <b>${yakitMaliyeti.toFixed(2)} TL</b>
                `;
                routeSummaryEl.style.display = 'block';

                setStatus(
                    "Rota çizildi. Toplam Süre: " + (tahminiVarisDk / 60).toFixed(1) + " saat. POI panelini kullanabilirsiniz."
                );

            } catch (err) {
                console.error(err);
                alert("Rota çizilirken bir hata oluştu: " + err.message);
                controlsEl.classList.remove('minimized');
                setStatus("Hata oluştu.");
            } finally {
                setLoading(false);
            }
        }
        
        // --- Konum Takibi ve Hız Göstergesi ---
        function updateSpeedometer(speedKmh, limitKmh) {
             currentSpeedEl.textContent = `${Math.round(speedKmh)} km/s`;
             speedLimitEl.textContent = `Limit: ${limitKmh} km/s`;
             
             // 3. GELİŞTİRME: Kırmızı Uyarı
             if (speedKmh > limitKmh) {
                 currentSpeedEl.classList.add('red-text');
             } else {
                 currentSpeedEl.classList.remove('red-text');
             }
        }
        
        // 3. GELİŞTİRME: Yükseklik Göstergesi Güncellemesi
        function updateAltitude(altitudeM) {
             if (ALTITUDE_DISPLAY_ACTIVE) {
                 altitudeDisplayEl.textContent = `Yükseklik: ${Math.round(altitudeM)} m`;
             }
        }

        function toggleGeolocation() {
             if (watchId) {
                // Kapatma
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                if (trackingMarker) {
                    map.removeLayer(trackingMarker);
                    trackingMarker = null;
                }
                speedometerEl.classList.add('hidden'); // Gizle
                trackBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Konum Takibi';
                trackBtn.style.background = 'var(--color-primary)';
                setStatus("Konum takibi durduruldu.");
            } else {
                // Açma
                if (!navigator.geolocation) {
                    alert('Tarayıcınız konum servislerini desteklemiyor.');
                    return;
                }
                
                routeLayerGroup.clearLayers(); 
                controlsEl.classList.remove('minimized');
                speedometerEl.classList.remove('hidden'); // Göster
                
                trackBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Başlatılıyor...';
                trackBtn.style.background = '#888';
                
                const bikeIcon = L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34]
                });
                
                let simulatedSpeedLimit = 70; 

                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        const latLng = [position.coords.latitude, position.coords.longitude];
                        const speedMps = position.coords.speed || 0; 
                        const speedKmh = speedMps * 3.6; 
                        const altitude = position.coords.altitude || 0; 

                        if (!trackingMarker) {
                            trackingMarker = L.marker(latLng, {icon: bikeIcon}).addTo(map);
                            trackingMarker.bindPopup("<b>Şu Anki Konumunuz</b>").openPopup();
                            map.setView(latLng, 14);
                        } else {
                            trackingMarker.setLatLng(latLng);
                            map.panTo(latLng); 
                        }
                        
                        // 3. GELİŞTİRME: Göstergeleri güncelle
                        updateSpeedometer(speedKmh, simulatedSpeedLimit);
                        updateAltitude(altitude);
                        
                        simulatedSpeedLimit = (latLng[0] < 40) ? 90 : 50; 

                        trackBtn.innerHTML = '<i class="fas fa-times-circle"></i> Takip Ediliyor';
                        trackBtn.style.background = 'var(--color-danger)';
                        setStatus(`Konum güncellendi. Hız: ${speedKmh.toFixed(0)} km/s`);
                    }, 
                    (error) => {
                        // HATA DÜZELTMESİ: Konum Hatası İyileştirmesi
                         let errMsg = "Konum takibi durduruldu. Lütfen cihazınızın/tarayıcınızın konum izinlerini kontrol edin.";
                         if (error.code === error.PERMISSION_DENIED) {
                             errMsg = "Konum izni reddedildi. Takip başlatılamadı.";
                         } else if (error.code === error.POSITION_UNAVAILABLE) {
                             errMsg = "Konum verisi mevcut değil (GPS sinyali yok veya kapalı).";
                         } else if (error.code === error.TIMEOUT) {
                             errMsg = "Konum zaman aşımına uğradı.";
                         }
                         alert(`Konum hatası: ${errMsg}`);
                        toggleGeolocation(); // Hata oluştuğunda takibi durdur
                    }, 
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            }
        }
        
        // --- Dışa Aktarma (Aynı kalır) ---
        function exportRoute(format) {
            if (!lastRouteGeoJSON) {
                alert("Önce bir rota çizmelisiniz.");
                return;
            }
            setStatus(`${format} dosyası oluşturuluyor...`);
            let output;
            let mimeType;
            let extension;
            if (format === 'GPX') {
                 const coords = lastRouteGeoJSON.features[0].geometry.coordinates;
                 const trackPoints = coords.map(c => `<trkpt lat="${c[1]}" lon="${c[0]}"></trkpt>`).join('');
                 output = `
<?xml version="1.0" encoding="UTF-8" standalone="no" ?>
<gpx xmlns="http://www.topografix.com/GPX/1/1" creator="Moto Rota Hava Durumu" version="1.1">
    <trk>
        <name>${lastRouteGeoJSON.features[0].properties.name}</name>
        <trkseg>${trackPoints}</trkseg>
    </trk>
</gpx>`.trim();
                mimeType = "application/gpx+xml";
                extension = "gpx";
            } else if (format === 'KML') {
                const coords = lastRouteGeoJSON.features[0].geometry.coordinates;
                const coordinateString = coords.map(c => `${c[0]},${c[1]},0`).join(' ');
                output = `
<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>${lastRouteGeoJSON.features[0].properties.name}</name>
    <Placemark>
      <name>Çizilen Rota</name>
      <LineString>
        <coordinates>${coordinateString}</coordinates>
      </LineString>
    </Placemark>
  </Document>
</kml>`.trim();
                mimeType = "application/vnd.google-earth.kml+xml";
                extension = "kml";
            } else {
                return;
            }
            const blob = new Blob([output], { type: mimeType });
            saveAs(blob, `moto_rota_${new Date().toISOString().slice(0, 10)}.${extension}`);
            setStatus(`${format} dosyası indirilmeye başlandı.`);
        }
        
        // --- Ayarları Güncelleme ve Kapatma ---
        function updateSettingsAndClose() {
            const newWarnWind = parseFloat(warnWindInput.value);
            const newDangerWind = parseFloat(dangerWindInput.value);
            const newWarnPrecip = parseFloat(warnPrecipInput.value);
            const newDangerPrecip = parseFloat(dangerPrecipInput.value);
            
            // Yeni V3 Ayar Değerleri
            const newYakitTuketimi = parseFloat(yakitTuketimiInput.value);
            const newYakitFiyati = parseFloat(yakitFiyatiInput.value);
            const newMolaFrekansDeger = parseFloat(molaFrekansDegerInput.value);
            
            SHOULD_SAVE_ROUTE = saveRouteToggle.checked;
            ALTITUDE_DISPLAY_ACTIVE = altitudeDisplayToggle.checked;
            AVOID_TOLLS = avoidTollsToggle.checked;
            AVOID_FERRIES = avoidFerriesToggle.checked;
            MOLA_AKTIF = molaToggle.checked;
            MOLA_FREKANSI_TIP = molaFrekansTipSelect.value;
            MOLA_FREKANSI_DEGER = newMolaFrekansDeger;

            // Giriş doğrulama
            if (newDangerWind <= newWarnWind || newDangerPrecip <= newWarnPrecip) {
                 alert("Yüksek Risk eşikleri, Orta Risk eşiklerinden kesinlikle büyük olmalıdır!");
                 fillSettingsInputs(); 
                 return;
            }

            if (!isNaN(newWarnWind) && newWarnWind >= 0) WARNING_WIND = newWarnWind;
            if (!isNaN(newDangerWind) && newDangerWind >= 0) DANGER_WIND = newDangerWind;
            if (!isNaN(newWarnPrecip) && newWarnPrecip >= 0) WARNING_PRECIP = newWarnPrecip;
            if (!isNaN(newDangerPrecip) && newDangerPrecip >= 0) DANGER_PRECIP = newDangerPrecip;
            if (!isNaN(newYakitTuketimi) && newYakitTuketimi > 0) YAKIT_TUKETIMI = newYakitTuketimi;
            if (!isNaN(newYakitFiyati) && newYakitFiyati > 0) YAKIT_FIYATI = newYakitFiyati;
            if (!isNaN(newMolaFrekansDeger) && newMolaFrekansDeger > 0) MOLA_FREKANSI_DEGER = newMolaFrekansDeger;

            saveSettings();
            updateAltitudeDisplay();
            updateLegend();
            settingsModal.style.display = 'none';
            setStatus(`Ayarlar kaydedildi. Rota Tercihleri: Ücretli Yollar: ${AVOID_TOLLS ? 'Kaçın' : 'Serbest'}. Yeni rota çiziniz.`);
        }
        
        // --- Event Dinleyicileri ---
        routeBtn.addEventListener("click", handleRoute);
        trackBtn.addEventListener("click", toggleGeolocation);
        settingsBtn.addEventListener('click', () => { fillSettingsInputs(); settingsModal.style.display = 'block'; });
        closeSettingsBtn.addEventListener('click', updateSettingsAndClose);
        
        exportGPXBtn.addEventListener('click', () => exportRoute('GPX'));
        exportKMLBtn.addEventListener('click', () => exportRoute('KML'));
        
        useStartLocBtn.addEventListener('click', () => {
             if (!navigator.geolocation) { alert('Tarayıcınız konum servislerini desteklemiyor.'); return; }
            setStatus("Konumunuz alınıyor...");
            useStartLocBtn.disabled = true;
            
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                const address = await reverseGeocode(lat, lon);
                startInput.value = address;
                
                map.setView([lat, lon], 12);
                L.marker([lat, lon], {icon: L.icon({iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]})}).addTo(routeLayerGroup).bindPopup("Başlangıç Konumunuz").openPopup();

                setStatus("Başlangıç konumu ayarlandı.");
                useStartLocBtn.disabled = false;
            }, (err) => {
                 // HATA DÜZELTMESİ: Konum Hatası İyileştirmesi
                 let errMsg = "Konum alınamadı. Lütfen cihazınızın/tarayıcınızın konum izinlerini kontrol edin.";
                 if (err.code === err.PERMISSION_DENIED) {
                     errMsg = "Konum izni reddedildi. Başlangıç adresini elle giriniz.";
                 } else if (err.code === err.POSITION_UNAVAILABLE) {
                     errMsg = "Konum verisi mevcut değil (GPS sinyali yok veya kapalı).";
                 }
                 alert(`Konum hatası: ${errMsg}`);
                 setStatus("Başlangıç konumu ayarlanamadı.");
                 useStartLocBtn.disabled = false;
            }, {
                enableHighAccuracy: true,
                timeout: 10000
            });
        });
        
        document.getElementById("startInput").addEventListener("keypress", function(e) { if (e.key === 'Enter') handleRoute(); });
        document.getElementById("endInput").addEventListener("keypress", function(e) { if (e.key === 'Enter') handleRoute(); });
        document.getElementById("departureInput").addEventListener("keypress", function(e) { if (e.key === 'Enter') handleRoute(); });

        importFile.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                importBtn.disabled = false;
                setStatus(`${e.target.files[0].name} dosyası yüklendi. Haritada göstermek için tıklayın.`);
            } else {
                importBtn.disabled = true;
            }
        });
        
        importBtn.addEventListener('click', () => {
            const file = importFile.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const parser = new DOMParser();
                    const gpxOrKml = parser.parseFromString(event.target.result, "text/xml");
                    
                    let geojson;
                    if (file.name.endsWith('.gpx')) {
                        geojson = toGeoJSON.gpx(gpxOrKml);
                    } else if (file.name.endsWith('.kml')) {
                        geojson = toGeoJSON.kml(gpxOrKml);
                    } else {
                        throw new Error("Desteklenmeyen dosya formatı.");
                    }

                    importedRouteLayer.clearLayers(); 

                    L.geoJSON(geojson, {
                        style: function (feature) {
                            return { color: 'yellow', weight: 4, opacity: 0.7 }; 
                        },
                        pointToLayer: function (feature, latlng) {
                            return L.circleMarker(latlng, { radius: 5, color: 'orange', fillColor: 'orange', fillOpacity: 0.8 });
                        }
                    }).addTo(importedRouteLayer);
                    
                    if (importedRouteLayer.getLayers().length > 0) {
                        map.fitBounds(importedRouteLayer.getBounds());
                        setStatus(`'${file.name}' dosyası haritaya yüklendi. İçe aktarılan rota sarı renkte.`);
                    }

                } catch (error) {
                    setStatus(`Hata: ${file.name} dosyası işlenemedi: ${error.message}`);
                    console.error("İçe Aktarma Hatası:", error);
                }
            };
            reader.readAsText(file);
            importBtn.disabled = true;
            importFile.value = ''; 
        });
    </script>
</body>
</html>
