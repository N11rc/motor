<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <title>Moto Rota Hava Durumu - Tam Uyumlu UX (v7)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""
    />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        :root {
            --color-bg: #111;
            --color-text: #eee;
            --color-primary: #1e88e5;
            --color-danger: #f44336;
            --color-warning: #ff9800;
            --color-success: #4caf50;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            overflow: hidden; 
        }
        
        /* Tüm elementler için sınırlayıcı kutu modelini kullan */
        * {
            box-sizing: border-box; 
        }

        /* --- ANA KONTROL PANELİ STİLİ --- */
        #controls {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 10px;
            background: var(--color-bg);
            color: var(--color-text);
            display: flex;
            flex-direction: column; 
            gap: 10px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            max-height: 250px; 
            overflow: hidden;
            width: 100%; /* Tam genişlik */
        }

        #controls.minimized {
            max-height: 65px; 
            padding-bottom: 5px;
        }
        
        #controls-inputs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            flex-grow: 1;
            align-items: flex-end;
            transition: opacity 0.3s;
            width: 100%; 
        }

        #controls.minimized #controls-inputs {
            opacity: 0;
            pointer-events: none;
            height: 0;
            margin-bottom: -10px; 
        }

        #controls label {
            display: flex;
            flex-direction: column;
            font-size: 13px;
            flex-grow: 1; 
            min-width: 140px; 
            position: relative;
        }
        
        /* Input ve Label'ları her zaman tam genişlikte tut (Mobil Fix) */
        @media (max-width: 768px) {
            #controls label,
            #controls-inputs {
                width: 100%;
            }
            #controls label {
                min-width: unset;
            }
        }
        
        .location-button {
            position: absolute;
            right: 1px; 
            top: 50%;
            transform: translateY(calc( -50% + 8px));
            cursor: pointer;
            color: var(--color-primary);
            background: none;
            border: none;
            padding: 7px; 
            z-index: 2;
            font-size: 16px;
        }

        #controls input {
            background: #222;
            padding-right: 35px; 
            width: 100%; /* Mobil Fix */
        }

        /* Butonlar Grubu - Mobil düzenleme */
        #controls-buttons {
             display: flex;
             gap: 10px;
             width: 100%; 
        }
        
        #routeBtn, #trackBtn, #settingsBtn {
            padding: 8px 10px;
            font-size: 14px;
            border-radius: 4px;
            border: none;
            color: white;
            cursor: pointer;
            transition: background 0.2s;
            white-space: nowrap; 
        }
        
        #routeBtn { background: var(--color-primary); flex-grow: 2; }
        #trackBtn { background: var(--color-primary); flex-grow: 2; }
        #settingsBtn { background: #444; flex-grow: 1; }
        
        /* ... Diğer CSS kodları aynı kalır ... */

        #status-container {
            width: 100%;
            padding: 5px 0 0;
            display: flex;
            align-items: center;
        }
        
        #status {
            font-size: 13px;
            color: #ccc;
            flex-grow: 1;
        }

        #map {
            width: 100%;
            height: 100vh;
        }

        /* --- LEAFLET KONTROL İYİLEŞTİRMELERİ --- */
        .leaflet-control-zoom {
            border-radius: 4px !important;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
        }
        .leaflet-control-zoom-in, .leaflet-control-zoom-out {
            font-size: 18px !important;
            padding: 5px 8px !important;
            line-height: 1.2 !important;
        }
        
        @media (max-width: 768px) {
            .leaflet-top.leaflet-left {
                top: unset !important;
                left: unset !important;
                bottom: 100px !important; 
                right: 10px !important;
            }
            
            #controls.minimized {
                max-height: 100px;
            }
            
            #controls-buttons {
                justify-content: space-between;
            }
        }
        
        /* --- AYARLAR MODAL STİLİ --- */
        #settingsModal {
            position: fixed; /* 'absolute' yerine 'fixed' kullandık, bu mobil kaydırma sorununu engeller */
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            color: var(--color-text);
            z-index: 1001;
            display: none; 
            padding: 20px;
            overflow-y: auto;
            box-sizing: border-box;
        }
        
        #settingsModal h2 {
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
            margin-top: 0;
        }
        
        #settingsModal .close-button {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
        }
        
        .setting-group {
            margin-bottom: 25px;
            padding: 10px;
            background: #222;
            border-radius: 8px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #333;
        }
        .setting-item:last-child {
            border-bottom: none;
        }
        .setting-item label {
            flex-grow: 1;
        }
        .setting-item input[type="number"] {
            width: 70px;
            background: #333;
            border: none;
            color: var(--color-text);
            padding: 5px;
            border-radius: 4px;
            text-align: right;
        }
    </style>
</head>
<body>
    <div id="controls">
        <div id="controls-inputs">
            <label>Başlangıç:
                <input id="startInput" type="text" placeholder="Örn: Pendik, İstanbul" />
                <button class="location-button" id="useStartLocBtn" title="Mevcut Konumumu Kullan"><i class="fas fa-crosshairs"></i></button>
            </label>
            <label>Bitiş:
                <input id="endInput" type="text" placeholder="Örn: Milas, Muğla" />
            </label>
            <label>Çıkış saati (Şimdi):
                <input id="departureInput" type="datetime-local" /> 
            </label>
        </div>
        
        <div id="controls-buttons">
            <button id="routeBtn"><i class="fas fa-motorcycle"></i> Rota Çiz</button>
            <button id="trackBtn"><i class="fas fa-location-arrow"></i> Konum Takibi</button>
            <button id="settingsBtn" title="Ayarlar"><i class="fas fa-cog"></i></button>
        </div>
        
        <div id="status-container">
            <span id="status">Harita hazırlanıyor...</span>
        </div>
    </div>
    
    <div id="settingsModal">
        <div class="close-button" id="closeSettingsBtn">&times;</div>
        <h2><i class="fas fa-cog"></i> Uygulama Ayarları</h2>
        
        <div class="setting-group">
            <h3>Rota Parametreleri (Risk Eşikleri)</h3>
            <div class="setting-item">
                <label for="warnWind">Orta Risk Rüzgar Hızı (km/s):</label>
                <input type="number" id="warnWind" min="1" max="100" />
            </div>
            <div class="setting-item">
                <label for="dangerWind">Yüksek Risk Rüzgar Hızı (km/s):</label>
                <input type="number" id="dangerWind" min="1" max="100" />
            </div>
            <div class="setting-item">
                <label for="warnPrecip">Orta Risk Yağış (mm/saat):</label>
                <input type="number" id="warnPrecip" step="0.1" min="0" max="10" />
            </div>
            <div class="setting-item">
                <label for="dangerPrecip">Yüksek Risk Yağış (mm/saat):</label>
                <input type="number" id="dangerPrecip" step="0.1" min="0" max="10" />
            </div>
        </div>
        
        <div class="setting-group">
            <h3>Görünüm ve Harita (Yakında)</h3>
            <p>Harita teması (Gece/Gündüz) ve POI (Benzin, Kamp Alanı) ayarları buraya gelecek.</p>
        </div>
        
        <div class="setting-group">
            <h3>Veri ve Geçmiş (Yakında)</h3>
            <p>Son rotalarınız ve tercihlerinizi yönetme seçenekleri buraya gelecek.</p>
        </div>
    </div>
    
    <div id="map"></div>

    <script
        src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""
    ></script>

    <script>
        // --- Sabitler ve Ayarlar ---
        // Varsayılan değerler
        let DANGER_WIND = 40; 
        let WARNING_WIND = 25; 
        let DANGER_PRECIP = 2; 
        let WARNING_PRECIP = 0.1; 
        
        const MIN_SEGMENT_DISTANCE_KM = 10; 
        const MIN_SAMPLE_COUNT = 10; 

        // --- Yerel Depolama (localStorage) İşlemleri ---
        
        // Ayarları yükle
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('motoRouteSettings'));
            if (settings) {
                // Değişkenleri yerel depolamadan alınan değerlerle güncelle
                DANGER_WIND = settings.dangerWind || DANGER_WIND;
                WARNING_WIND = settings.warnWind || WARNING_WIND;
                DANGER_PRECIP = settings.dangerPrecip || DANGER_PRECIP;
                WARNING_PRECIP = settings.warnPrecip || WARNING_PRECIP;
                
                // Input alanlarını yüklenen değerlerle doldur
                document.getElementById('warnWind').value = WARNING_WIND;
                document.getElementById('dangerWind').value = DANGER_WIND;
                document.getElementById('warnPrecip').value = WARNING_PRECIP;
                document.getElementById('dangerPrecip').value = DANGER_PRECIP;
            } else {
                 // Ayar yoksa varsayılanları inputlara yaz
                document.getElementById('warnWind').value = WARNING_WIND;
                document.getElementById('dangerWind').value = DANGER_WIND;
                document.getElementById('warnPrecip').value = WARNING_PRECIP;
                document.getElementById('dangerPrecip').value = DANGER_PRECIP;
            }
            // Legend'ı (gösterge) da güncelleyelim
            updateLegend();
        }

        // Ayarları kaydet
        function saveSettings() {
            WARNING_WIND = parseFloat(document.getElementById('warnWind').value) || 25;
            DANGER_WIND = parseFloat(document.getElementById('dangerWind').value) || 40;
            WARNING_PRECIP = parseFloat(document.getElementById('warnPrecip').value) || 0.1;
            DANGER_PRECIP = parseFloat(document.getElementById('dangerPrecip').value) || 2;
            
            const settings = {
                warnWind: WARNING_WIND,
                dangerWind: DANGER_WIND,
                warnPrecip: WARNING_PRECIP,
                dangerPrecip: DANGER_PRECIP
            };
            localStorage.setItem('motoRouteSettings', JSON.stringify(settings));
            
            updateLegend();
            setStatus("Ayarlar kaydedildi. Yeni rota çizimi için geçerli olacak.");
        }
        
        // --- Haritayı başlat & Legend Güncelleme ---
        
        const map = L.map("map", { zoomControl: false }); 
        
        // Legend öğesini global bir değişken yap
        let customLegend = null; 

        function updateLegend() {
            // Eskiyi varsa kaldır
            if (customLegend) {
                map.removeControl(customLegend);
            }
            
            // Yeni Legend oluştur
            customLegend = L.control({ position: "bottomright" });
            customLegend.onAdd = function () {
                const div = L.DomUtil.create("div", "legend");
                div.innerHTML = `
                    <b>ROTA VE MARKER RİSK</b>
                    <div><span style="background:var(--color-danger)"></span> Yüksek Risk (> ${DANGER_WIND} km/s VEYA > ${DANGER_PRECIP} mm)</div>
                    <div><span style="background:var(--color-warning)"></span> Orta Risk (> ${WARNING_WIND} km/s VEYA > ${WARNING_PRECIP} mm)</div>
                    <div><span style="background:var(--color-success)"></span> Düşük Risk (İyi)</div>
                `;
                return div;
            };
            customLegend.addTo(map);
        }


        function setInitialMapView() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        map.setView([pos.coords.latitude, pos.coords.longitude], 10);
                        setStatus("Konumunuz bulundu, harita hazır.");
                    },
                    (err) => {
                        map.setView([39.0, 35.0], 6); 
                        setStatus("Harita hazır. Başlangıç ve bitiş giriniz.");
                    },
                    { enableHighAccuracy: false, timeout: 5000 }
                );
            } else {
                map.setView([39.0, 35.0], 6); 
                setStatus("Harita hazır. Başlangıç ve bitiş giriniz.");
            }
        }
        
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 18,
            attribution: '&copy; OSM & OSRM & Open-Meteo',
        }).addTo(map);

        setInitialMapView();
        loadSettings(); // Ayarları yükle
        
        // Yeni Zoom Kontrolü (Sağ altta)
        L.control.zoom({ position: 'bottomright' }).addTo(map);


        const routeLayerGroup = L.layerGroup().addTo(map);
        const weatherLayerGroup = L.layerGroup().addTo(map);
        let trackingMarker = null;
        let watchId = null; 

        const statusEl = document.getElementById("status");
        const controlsEl = document.getElementById("controls");
        const routeBtn = document.getElementById("routeBtn");
        const trackBtn = document.getElementById("trackBtn");
        const settingsBtn = document.getElementById("settingsBtn");
        const settingsModal = document.getElementById("settingsModal");
        const closeSettingsBtn = document.getElementById("closeSettingsBtn");
        const useStartLocBtn = document.getElementById("useStartLocBtn");
        const startInput = document.getElementById("startInput");


        function setStatus(msg) {
            statusEl.textContent = msg || "";
        }

        function setLoading(loading) {
            routeBtn.disabled = loading;
            const icon = loading ? 'fa-spinner fa-spin' : 'fa-motorcycle';
            routeBtn.innerHTML = `<i class="fas ${icon}"></i> ${loading ? "Hesaplanıyor..." : "Rota Çiz"}`;
        }
        
        // --- Hava Durumu Risk Fonksiyonu (Ayarları kullanır) ---
        
        function getWeatherRisk(info) {
            const { precipitation, wind } = info;
            if (precipitation > DANGER_PRECIP || wind >= DANGER_WIND) {
                return 3; 
            }
            if (precipitation > WARNING_PRECIP || wind >= WARNING_WIND) {
                return 2; 
            }
            return 1; 
        }

        function getRiskColor(riskLevel) {
            switch (riskLevel) {
                case 3: return "#f44336"; 
                case 2: return "#ff9800"; 
                default: return "#4caf50"; 
            }
        }
        
        // --- Diğer Yardımcı ve Ana Rota Fonksiyonları (Aynı kalır) ---

        async function geocode(query) {
            const url = "https://nominatim.openstreetmap.org/search?format=json&limit=1&q=" + encodeURIComponent(query);
            const res = await fetch(url, { headers: { "Accept-Language": "tr" } });
            if (!res.ok) throw new Error("Konum sorgulama başarısız: " + res.status);
            const data = await res.json();
            if (!data || data.length === 0) throw new Error("Konum bulunamadı: " + query);
            const item = data[0];
            return { lat: parseFloat(item.lat), lon: parseFloat(item.lon), display_name: item.display_name };
        }

        async function reverseGeocode(lat, lon) {
             const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`;
             const res = await fetch(url, { headers: { "Accept-Language": "tr" } });
             if (!res.ok) return `${lat.toFixed(4)}, ${lon.toFixed(4)}`; 
             const data = await res.json();
             return data.display_name || `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
        }
        
        async function getRoute(start, end) {
            const url = "https://router.project-osrm.org/route/v1/driving/" + [start.lon, start.lat].join(",") + ";" + [end.lon, end.lat].join(",") + "?overview=full&geometries=geojson";
            const res = await fetch(url);
            if (!res.ok) throw new Error("Rota isteği başarısız: " + res.status);
            const data = await res.json();
            if (!data.routes || data.routes.length === 0) throw new Error("Rota bulunamadı.");
            return data.routes[0];
        }

        function getLatLngCoords(geometry) {
            return geometry.coordinates.map((c) => [c[1], c[0]]); 
        }

        async function getHourlyWeather(lat, lon) {
            const url = "https://api.open-meteo.com/v1/forecast?latitude=" + lat + "&longitude=" + lon + "&hourly=temperature_2m,precipitation,wind_speed_10m&forecast_days=7&timezone=auto";
            const res = await fetch(url);
            if (!res.ok) throw new Error("Hava isteği başarısız: " + res.status);
            const data = await res.json();
            if (!data.hourly || !data.hourly.time) throw new Error("Saatlik hava verisi bulunamadı.");
            return data.hourly;
        }

        function findNearestHourIndex(times, targetDate) {
            let bestIdx = 0;
            let bestDiff = Infinity;
            for (let i = 0; i < times.length; i++) {
                const t = new Date(times[i]);
                const diff = Math.abs(t - targetDate);
                if (diff < bestDiff) {
                    bestDiff = diff;
                    bestIdx = i;
                }
            }
            return bestIdx;
        }

        async function handleRoute() {
            controlsEl.classList.add('minimized');
            // ... (Kalan Rota çizme fonksiyonu aynı kalır, sadece risk değişkenlerini globalden çeker)
            const endInput = document.getElementById("endInput");
            const departureInput = document.getElementById("departureInput");
            
            const startText = startInput.value.trim();
            const endText = endInput.value.trim();
            const departureInputVal = departureInput.value;

            if (!startText || !endText) {
                alert("Başlangıç ve bitiş noktalarını yazmalısınız.");
                controlsEl.classList.remove('minimized');
                return;
            }

            let departureTime = departureInputVal ? new Date(departureInputVal) : new Date();
            
            if (departureTime.toString() === "Invalid Date") {
                alert("Geçerli bir çıkış saati giriniz.");
                controlsEl.classList.remove('minimized');
                return;
            }

            routeLayerGroup.clearLayers();
            weatherLayerGroup.clearLayers();
            setStatus("Konumlar çözümleniyor...");
            setLoading(true);

            try {
                // 1) Geocode
                const [start, end] = await Promise.all([geocode(startText), geocode(endText)]);
                
                // Başlangıç/Bitiş Markerları
                const startIcon = L.icon({iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]});
                const endIcon = L.icon({iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]});
                
                L.marker([start.lat, start.lon], {icon: startIcon}).addTo(routeLayerGroup).bindPopup(`<b>Başlangıç:</b> ${start.display_name}`).openPopup();
                L.marker([end.lat, end.lon], {icon: endIcon}).addTo(routeLayerGroup).bindPopup(`<b>Bitiş:</b> ${end.display_name}`);

                setStatus("Rota hesaplanıyor...");

                // 2) Rota
                const route = await getRoute(start, end);
                const totalDistanceMeters = route.distance;
                const totalDurationSec = route.duration;
                
                // 3) Dinamik Segment Sayısı Hesaplama
                const requiredSegments = Math.ceil(totalDistanceMeters / (MIN_SEGMENT_DISTANCE_KM * 1000));
                const sampleCount = Math.max(MIN_SAMPLE_COUNT, requiredSegments); 

                const allRouteCoords = getLatLngCoords(route.geometry);
                const totalPoints = allRouteCoords.length;
                const indices = [];
                for (let i = 0; i < sampleCount; i++) {
                    indices.push(Math.round(i / (sampleCount - 1) * (totalPoints - 1)));
                }

                setStatus(`Hava durumu (${sampleCount} nokta) ve segmentler belirleniyor...`);
                
                let lastRisk = 0;
                let segmentStartIdx = 0;
                let segmentResults = [];

                for (let i = 0; i < indices.length; i++) {
                    const currentRouteIdx = indices[i];
                    const currentCoords = allRouteCoords[currentRouteIdx];
                    const fraction = currentRouteIdx / (totalPoints - 1); 
                    
                    const estimatedArrivalTime = new Date(
                        departureTime.getTime() + fraction * totalDurationSec * 1000
                    );

                    const hourly = await getHourlyWeather(currentCoords[0], currentCoords[1]);
                    const idx = findNearestHourIndex(hourly.time, estimatedArrivalTime);

                    const temp = hourly.temperature_2m[idx];
                    const precip = hourly.precipitation[idx];
                    const wind = hourly.wind_speed_10m[idx];
                    const risk = getWeatherRisk({ precipitation: precip, wind }); // GÜNCEL RİSK DEĞERLERİNİ KULLANIR
                    
                    // Marker (daire) oluştur
                    const markerColor = getRiskColor(risk);
                    const marker = L.circleMarker(currentCoords, {
                        radius: 5, 
                        color: markerColor,
                        weight: 1,
                        fillColor: markerColor,
                        fillOpacity: 0.8,
                    }).bindPopup(`
                        <b>Varış:</b> ${estimatedArrivalTime.toLocaleString("tr-TR")}<br/>
                        <b>Sıcaklık:</b> ${temp.toFixed(1)} °C<br/>
                        <b>Rüzgar:</b> ${wind.toFixed(1)} km/s<br/>
                        <b>Yağış:</b> ${precip.toFixed(2)} mm/saat
                    `);
                    weatherLayerGroup.addLayer(marker);
                    
                    // --- SEGMENTASYON MANTIĞI ---
                    if (risk !== lastRisk && lastRisk !== 0) {
                        const segmentCoords = allRouteCoords.slice(segmentStartIdx, currentRouteIdx + 1);
                        segmentResults.push({ coords: segmentCoords, color: getRiskColor(lastRisk) });
                        segmentStartIdx = currentRouteIdx;
                    }
                    
                    lastRisk = risk;

                    if (i === indices.length - 1) {
                         const segmentCoords = allRouteCoords.slice(segmentStartIdx, allRouteCoords.length);
                         segmentResults.push({ coords: segmentCoords, color: getRiskColor(lastRisk) });
                    }
                }
                
                // 4) Segmentleri haritaya çiz
                segmentResults.forEach(segment => {
                    const polyline = L.polyline(segment.coords, { 
                        color: segment.color, 
                        weight: 6, 
                        opacity: 0.8 
                    });
                    routeLayerGroup.addLayer(polyline);
                });
                
                // Haritayı rotaya odakla
                map.fitBounds(L.polyline(allRouteCoords).getBounds(), { padding: [80, 80] });

                setStatus(
                    "Rota çizildi. Toplam Mesafe: " + (totalDistanceMeters / 1000).toFixed(0) + " km. Toplam Süre: " +
                    (totalDurationSec / 3600).toFixed(1) +
                    " saat."
                );
            } catch (err) {
                console.error(err);
                alert("Rota çizilirken bir hata oluştu: " + err.message);
                controlsEl.classList.remove('minimized');
                setStatus("Hata oluştu.");
            } finally {
                setLoading(false);
            }
        }

        // ... (useStartLocBtn ve toggleGeolocation fonksiyonları aynı kalır)
        useStartLocBtn.addEventListener('click', () => {
             if (!navigator.geolocation) {
                alert('Tarayıcınız konum servislerini desteklemiyor.');
                return;
            }
            setStatus("Konumunuz alınıyor...");
            useStartLocBtn.disabled = true;
            
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                const address = await reverseGeocode(lat, lon);
                startInput.value = address;
                
                map.setView([lat, lon], 12);
                L.marker([lat, lon], {icon: L.icon({iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]})}).addTo(routeLayerGroup).bindPopup("Başlangıç Konumunuz").openPopup();

                setStatus("Başlangıç konumu ayarlandı.");
                useStartLocBtn.disabled = false;
            }, (err) => {
                 alert(`Konum alınamadı: ${err.message}`);
                 setStatus("Başlangıç konumu ayarlanamadı.");
                 useStartLocBtn.disabled = false;
            }, {
                enableHighAccuracy: true,
                timeout: 10000
            });
        });
        
        function toggleGeolocation() {
             if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                if (trackingMarker) {
                    map.removeLayer(trackingMarker);
                    trackingMarker = null;
                }
                trackBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Konum Takibi';
                trackBtn.style.background = 'var(--color-primary)';
                setStatus("Konum takibi durduruldu.");
            } else {
                if (!navigator.geolocation) {
                    alert('Tarayıcınız konum servislerini desteklemiyor.');
                    return;
                }
                
                trackBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Başlatılıyor...';
                trackBtn.style.background = '#888';
                
                const bikeIcon = L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34]
                });

                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        const latLng = [position.coords.latitude, position.coords.longitude];
                        
                        if (!trackingMarker) {
                            trackingMarker = L.marker(latLng, {icon: bikeIcon}).addTo(map);
                            trackingMarker.bindPopup("<b>Şu Anki Konumunuz</b>").openPopup();
                            map.setView(latLng, 14);
                        } else {
                            trackingMarker.setLatLng(latLng);
                            map.panTo(latLng); 
                        }
                        
                        trackBtn.innerHTML = '<i class="fas fa-times-circle"></i> Takip Ediliyor';
                        trackBtn.style.background = 'var(--color-danger)';
                        setStatus(`Konum güncellendi. Doğruluk: ${position.coords.accuracy.toFixed(0)}m.`);
                    }, 
                    (error) => {
                        alert(`Konum hatası: ${error.message}`);
                        toggleGeolocation();
                    }, 
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            }
        }
        
        // --- AYARLAR MODAL İŞLEYİCİLERİ ---
        settingsBtn.addEventListener('click', () => {
            // Modalı açmadan önce kaydedilmiş değerleri yükle (loadSettings en başta çağrıldığı için gerekli değil ama burada tekrar kontrol edebiliriz)
            loadSettings(); 
            settingsModal.style.display = 'block';
        });
        
        closeSettingsBtn.addEventListener('click', () => {
            // Modal kapatılınca ayarları kaydet
            saveSettings();
            settingsModal.style.display = 'none';
        });

        // --- Event Dinleyicileri ---
        routeBtn.addEventListener("click", handleRoute);
        trackBtn.addEventListener("click", toggleGeolocation);
        
        document.getElementById("startInput").addEventListener("keypress", function(e) { if (e.key === 'Enter') handleRoute(); });
        document.getElementById("endInput").addEventListener("keypress", function(e) { if (e.key === 'Enter') handleRoute(); });
        document.getElementById("departureInput").addEventListener("keypress", function(e) { if (e.key === 'Enter') handleRoute(); });
        
    </script>
</body>
</html>
